# 🔑 主键配置

**复合主键映射详解**

---

## 📋 功能概述

主键是匹配手工表和系统表对应行的关键。通过主键映射，系统能够准确找到两表中相同的数据进行比对。

### 什么是主键？

主键是能够**唯一标识**一条数据记录的字段或字段组合。

**单主键示例**:
- 订单编号 → 每个订单有唯一编号

**复合主键示例**:
- 订单编号 + 物料编码 → 同一订单可能包含多种物料

---

## 🎨 界面说明

### 主键映射区域

```
┌─────────────────────────────────────────────────────┐
│ 🔑 主键映射                                [➕ 添加] │
├─────────────────────────────────────────────────────┤
│                                                     │
│   手工表列           系统表列                        │
│  ┌──────────┐  ↔  ┌──────────┐   [✕]               │
│  │ 订单编号 ▼│      │ 订单编号 ▼│                    │
│  └──────────┘      └──────────┘                    │
│                                                     │
│  ┌──────────┐  ↔  ┌──────────┐   [✕]               │
│  │ 物料编码 ▼│      │ 零件号   ▼│                    │
│  └──────────┘      └──────────┘                    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 界面元素

| 元素 | 说明 |
|------|------|
| 手工表列下拉框 | 选择手工表中的主键列 |
| 系统表列下拉框 | 选择系统表中对应的列 |
| ↔ 符号 | 表示字段映射关系 |
| ✕ 按钮 | 删除该主键映射 |
| ➕ 添加 | 添加新的主键字段 |

---

## 📝 配置步骤

### 步骤1: 添加主键映射

1. 点击「➕ 添加主键」按钮
2. 新增一行主键映射

### 步骤2: 选择手工表列

1. 点击左侧下拉框
2. 选择手工表中的主键列

### 步骤3: 选择系统表列

1. 点击右侧下拉框
2. 选择系统表中对应的列

### 步骤4: 添加更多主键（可选）

如需复合主键，重复步骤1-3添加更多字段。

---

## 📊 主键类型

### 单字段主键

只使用一个字段作为主键：

```
手工表             系统表
订单编号    ↔    订单编号
```

**适用场景**:
- 订单编号唯一
- 每行数据可用单一字段区分

### 多字段主键（复合主键）

使用多个字段组合作为主键：

```
手工表             系统表
订单编号    ↔    订单编号
物料编码    ↔    零件号
```

**适用场景**:
- 订单编号不唯一（一个订单多个物料）
- 需要多字段组合才能唯一标识

---

## 🔧 主键生成规则

### 复合主键格式

系统会将多个主键字段用 `_` 连接：

```
__KEY__ = 主键1_主键2_主键3
```

**示例**:
| 订单编号 | 物料编码 | __KEY__ |
|---------|---------|---------|
| A001 | M001 | A001_M001 |
| A001 | M002 | A001_M002 |
| A002 | M001 | A002_M001 |

### 主键处理

- 自动去除前后空格
- 自动转换为字符串
- 空值处理为空字符串

---

## ⚠️ 注意事项

### 1. 列名不同的映射

手工表和系统表的列名可能不同：

```
手工表: 物料编码
系统表: 零件号       ← 名称不同但含义相同
```

只需在映射中正确对应即可。

### 2. 主键必须能唯一标识

❌ **错误示例**: 只用「日期」作为主键
- 同一天可能有多条数据
- 会导致匹配错误

✅ **正确示例**: 「日期 + 订单号 + 物料」
- 组合后能唯一标识

### 3. 主键值一致性

确保两表中主键值格式一致：

❌ 手工表: `A001`，系统表: `A-001`
✅ 使用数据清洗统一格式

### 4. 避免空主键

主键列不应有空值，空值会导致匹配失败。

---

## 📊 配置示例

### 示例1: 订单对账

```
场景: 对账订单数量
主键: 订单编号（唯一）

手工表列          系统表列
订单编号    ↔    订单编号
```

### 示例2: 库存对账

```
场景: 对账库存数量
主键: 仓库 + SKU（组合唯一）

手工表列          系统表列
仓库代码    ↔    仓库代码
SKU        ↔    物料编码
```

### 示例3: ASN送货单对账

```
场景: 对账送货单执行情况
主键: 到货单号 + 物料（组合唯一）

手工表列          系统表列
到货单号    ↔    ASN单号
零件号     ↔    物料号
```

---

## 💻 技术实现

### 配置数据格式

```python
key_mappings = [
    {"manual": "订单编号", "system": "订单编号"},
    {"manual": "物料编码", "system": "零件号"}
]
```

### 核心函数

```python
from core.compare_engine import CompareEngine

# 生成复合主键
df = CompareEngine.make_key(
    df=dataframe,
    key_cols=["订单编号", "物料编码"],
    keyname="__KEY__"
)

# 结果: 新增 __KEY__ 列
# __KEY__ = "A001_M001"
```

### 相关文件

| 文件 | 说明 |
|------|------|
| `ui/qt_config_panel.py` | KeyMappingRow 组件 |
| `core/compare_engine.py` | make_key() 方法 |

---

## ❓ 常见问题

### Q1: 主键映射后匹配数量很少？

**可能原因**:
- 主键值格式不一致（如空格、大小写）
- 选错了列

**解决方案**:
- 使用数据清洗统一格式
- 检查样例数据确认列选择正确

### Q2: 复合主键顺序重要吗？

**答案**: 不重要，只要两表映射正确即可。

系统会按照配置顺序生成KEY，但最终比对只看KEY是否相等。

### Q3: 可以添加几个主键？

**答案**: 理论上无限制，但建议不超过5个。

主键过多会影响性能和可读性。

---

## ▶️ 下一步

主键配置完成后，继续配置 [数据清洗](./05-数据清洗.md) 或 [筛选条件](./06-筛选条件.md)。
