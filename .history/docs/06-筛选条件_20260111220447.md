# 🔍 筛选条件

**多种筛选操作符详解**

---

## 📋 功能概述

筛选条件用于在对账前过滤数据，只保留需要对账的数据行。

### 筛选场景

- 只对账「已审核」的数据
- 排除「已取消」的订单
- 筛选特定日期范围的数据
- 筛选特定状态的订单

---

## 🎨 界面说明

### 筛选条件区域

```
┌─────────────────────────────────────────────────────────────┐
│ 🔍 手工表筛选                                    [➕ 添加]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌────────┐  ┌────────┐  ┌──────────────────────┐          │
│  │ 状态  ▼│  │ 等于  ▼│  │ 已审核            ▼│   [✕]    │
│  └────────┘  └────────┘  └──────────────────────┘          │
│      列        操作符            值                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 界面元素

| 元素 | 说明 |
|------|------|
| 列下拉框 | 选择要筛选的列 |
| 操作符下拉框 | 选择筛选操作符 |
| 值控件 | 输入或选择筛选值 |
| ✕ 按钮 | 删除该筛选条件 |
| ➕ 添加 | 添加新的筛选条件 |

---

## 📊 筛选操作符

### 操作符列表

| 操作符 | 内部代码 | 说明 | 值控件 |
|--------|---------|------|--------|
| 等于 | EQUALS | 精确匹配 | 下拉选择 |
| 不等于 | NOT_EQUALS | 排除匹配 | 下拉选择 |
| 包含 | CONTAINS | 部分包含 | 文本输入 |
| 不包含 | NOT_CONTAINS | 不包含 | 文本输入 |
| 包含于 | IN_LIST | 在列表中 | 多选复选框 |
| 不包含于 | NOT_IN_LIST | 不在列表中 | 多选复选框 |
| 大于 | GREATER | 数值大于 | 文本输入 |
| 小于 | LESS | 数值小于 | 文本输入 |

---

## 📝 操作符详解

### 1️⃣ 等于 (EQUALS)

**功能**: 筛选值完全等于指定值的行

**值控件**: 下拉选择（列出该列的所有唯一值）

**示例**:
```
列: 状态
操作符: 等于
值: 已完成

结果: 只保留状态="已完成"的行
```

### 2️⃣ 不等于 (NOT_EQUALS)

**功能**: 排除值等于指定值的行

**值控件**: 下拉选择

**示例**:
```
列: 状态
操作符: 不等于
值: 已取消

结果: 排除状态="已取消"的行
```

### 3️⃣ 包含 (CONTAINS)

**功能**: 筛选值包含指定文本的行

**值控件**: 文本输入（支持多值，逗号分隔）

**示例**:
```
列: 备注
操作符: 包含
值: 退货,换货

结果: 保留备注中包含"退货"或"换货"的行
```

### 4️⃣ 不包含 (NOT_CONTAINS)

**功能**: 排除值包含指定文本的行

**值控件**: 文本输入

**示例**:
```
列: 备注
操作符: 不包含
值: 测试

结果: 排除备注中包含"测试"的行
```

### 5️⃣ 包含于 (IN_LIST)

**功能**: 筛选值在指定列表中的行

**值控件**: 多选复选框（列出所有唯一值）

**示例**:
```
列: 状态
操作符: 包含于
值: [已完成, 已发货, 已签收]  ← 勾选多个

结果: 保留状态在这三个值中的行
```

### 6️⃣ 不包含于 (NOT_IN_LIST)

**功能**: 排除值在指定列表中的行

**值控件**: 多选复选框

**示例**:
```
列: 状态
操作符: 不包含于
值: [已取消, 已退货]

结果: 排除状态为这两个值的行
```

### 7️⃣ 大于 (GREATER)

**功能**: 筛选数值大于指定值的行

**值控件**: 文本输入

**示例**:
```
列: 数量
操作符: 大于
值: 0

结果: 保留数量>0的行
```

### 8️⃣ 小于 (LESS)

**功能**: 筛选数值小于指定值的行

**值控件**: 文本输入

**示例**:
```
列: 数量
操作符: 小于
值: 1000

结果: 保留数量<1000的行
```

---

## 🔗 多条件组合

### AND逻辑（同时满足）

添加多条筛选条件时，条件之间是 **AND** 关系：

```
条件1: 状态 等于 已完成
条件2: 数量 大于 0

结果: 状态="已完成" AND 数量>0
```

### 筛选顺序

多条件按**从上到下**顺序执行，每条筛选后数据量可能减少。

---

## 📊 配置示例

### 示例1: 只对账已审核数据

```
手工表筛选:
  列: 审核状态
  操作符: 等于
  值: 已审核
```

### 示例2: 排除取消和退货

```
系统表筛选:
  列: 订单状态
  操作符: 不包含于
  值: [已取消, 已退货, 已关闭]
```

### 示例3: 筛选特定业务类型

```
手工表筛选:
  条件1:
    列: 业务类型
    操作符: 包含于
    值: [发货, 退货, 退仓]
  条件2:
    列: 数量
    操作符: 大于
    值: 0
```

### 示例4: 排除测试数据

```
系统表筛选:
  列: 备注
  操作符: 不包含
  值: 测试
```

---

## 🎨 值控件智能切换

根据选择的操作符，值控件会自动切换：

| 操作符 | 值控件类型 | 说明 |
|--------|-----------|------|
| 等于/不等于 | 下拉选择 | 从唯一值列表选择 |
| 包含于/不包含于 | 多选复选框 | 可勾选多个值 |
| 包含/不包含 | 文本输入 | 支持多值，逗号分隔 |
| 大于/小于 | 文本输入 | 输入数值 |

---

## ⚠️ 注意事项

### 1. 筛选是不可逆的

筛选会减少参与对账的数据量，确保筛选条件正确。

### 2. 大小写敏感

字符串比较是**大小写敏感**的：
- `已完成` ≠ `已完成 ` (有空格)
- 建议配合数据清洗去除空格

### 3. 空值处理

- 空值不会匹配任何条件
- 使用「不等于」时，空值行也会被排除

### 4. 数值比较

大于/小于操作符会尝试将值转为数值：
- 非数值会转换失败，该行会被排除
- 确保筛选列是数值类型

---

## 💻 技术实现

### 配置数据格式

```python
filters = [
    {"column": "状态", "operator": "EQUALS", "value": "已完成"},
    {"column": "数量", "operator": "GREATER", "value": "0"}
]
```

### 操作符映射

```python
OPERATOR_MAP = {
    "等于": "EQUALS",
    "不等于": "NOT_EQUALS",
    "包含": "CONTAINS",
    "不包含": "NOT_CONTAINS",
    "包含于": "IN_LIST",
    "不包含于": "NOT_IN_LIST",
    "大于": "GREATER",
    "小于": "LESS"
}
```

### 筛选逻辑

```python
# 等于
df = df[df[col] == val]

# 包含
df = df[df[col].str.contains(val, na=False)]

# 包含于
df = df[df[col].isin(values)]

# 大于
df = df[pd.to_numeric(df[col], errors='coerce') > float(val)]
```

---

## ▶️ 下一步

筛选条件配置完成后，继续配置 [透视聚合](./07-透视聚合.md)。
