# 📋 模板管理

**配置模板保存与加载指南**

---

## 📋 功能概述

模板管理功能允许用户保存常用的对账配置，便于重复使用。

### 核心特性

- ✅ 保存配置模板
- ✅ 加载已保存模板
- ✅ 删除无用模板
- ✅ 同名自动覆盖

---

## 🎨 界面说明

### 模板工具栏

```
┌─────────────────────────────────────────────────────────────────────────┐
│  模板: [选择模板 ▼]    [💾 保存]  [📂 加载]  [🗑️ 删除]                  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 组件说明

| 组件 | 类型 | 说明 |
|------|------|------|
| 模板下拉框 | QComboBox | 选择已保存的模板 |
| 保存按钮 | QPushButton | 保存当前配置 |
| 加载按钮 | QPushButton | 加载选中模板 |
| 删除按钮 | QPushButton | 删除选中模板 |

---

## 💾 保存模板

### 操作步骤

1. 完成配置（主键、数值列、筛选等）
2. 点击「💾 保存」按钮
3. 输入模板名称
4. 点击「确定」

### 保存对话框

```
┌─────────────────────────────────────┐
│         保存配置模板                │
├─────────────────────────────────────┤
│                                     │
│   请输入模板名称:                   │
│   ┌─────────────────────────────┐   │
│   │ ASN对账-标准模板            │   │
│   └─────────────────────────────┘   │
│                                     │
│         [取消]    [确定]            │
│                                     │
└─────────────────────────────────────┘
```

### 保存内容

模板会保存以下配置：

| 配置项 | 说明 |
|--------|------|
| key_mappings | 主键映射 |
| value_mapping | 数值列映射 |
| clean_rules | 数据清洗规则 |
| manual_filters | 手工表筛选条件 |
| system_filters | 系统表筛选条件 |
| manual_pivot_config | 手工表透视配置 |
| system_pivot_config | 系统表透视配置 |
| difference_formula | 差值公式 |

### 不保存的内容

| 内容 | 原因 |
|------|------|
| 文件路径 | 每次可能不同 |
| Sheet选择 | 依赖具体文件 |
| 对账结果 | 临时数据 |

---

## 📂 加载模板

### 操作步骤

1. 从下拉框选择模板
2. 点击「📂 加载」按钮
3. 配置自动应用到面板

### 加载效果

```
加载前:
┌─────────────────────────────────────┐
│ 主键映射: (空)                      │
│ 筛选条件: (空)                      │
│ 差值公式: 手工数量 - 系统总计       │
└─────────────────────────────────────┘

加载后:
┌─────────────────────────────────────┐
│ 主键映射: 到货单号 ↔ ASN编号        │
│ 筛选条件: 状态 = 已审核             │
│ 差值公式: 手工数量 - (系统总计-已关闭) │
└─────────────────────────────────────┘
```

### 列名匹配

加载模板后，系统会尝试匹配当前文件的列名：
- ✅ 列名存在：自动选中
- ⚠️ 列名不存在：显示警告，需手动选择

---

## 🗑️ 删除模板

### 操作步骤

1. 从下拉框选择要删除的模板
2. 点击「🗑️ 删除」按钮
3. 确认删除

### 确认对话框

```
┌─────────────────────────────────────┐
│         确认删除                    │
├─────────────────────────────────────┤
│                                     │
│   ⚠️ 确定要删除模板                 │
│   "ASN对账-标准模板" 吗？           │
│                                     │
│   此操作不可恢复。                  │
│                                     │
│         [取消]    [确定]            │
│                                     │
└─────────────────────────────────────┘
```

---

## 📁 存储位置

### Windows

```
%APPDATA%\SupplyChain-Reconciler-Plus\templates.json
```

示例：`C:\Users\用户名\AppData\Roaming\SupplyChain-Reconciler-Plus\templates.json`

### macOS

```
~/Library/Application Support/SupplyChain-Reconciler-Plus/templates.json
```

### Linux

```
~/.config/SupplyChain-Reconciler-Plus/templates.json
```

---

## 📋 模板文件格式

### JSON结构

```json
{
  "templates": [
    {
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "name": "ASN对账-标准模板",
      "config": {
        "key_mappings": [
          {
            "manual_col": "到货单号",
            "system_col": "ASN编号"
          },
          {
            "manual_col": "物料编码",
            "system_col": "零件号"
          }
        ],
        "value_mapping": {
          "manual_col": "数量",
          "system_col": "执行数量"
        },
        "clean_rules": [
          {
            "table_type": "manual",
            "column": "到货单号",
            "mode": "删除匹配",
            "regexes": ["-\\d+$"]
          }
        ],
        "manual_filters": [
          {
            "column": "状态",
            "operator": "等于",
            "value": "已审核"
          }
        ],
        "system_filters": [],
        "manual_pivot_config": {
          "enabled": true,
          "pivot_column": "业务类型",
          "out_values": ["正常到货"],
          "in_values": ["退货"]
        },
        "system_pivot_config": {
          "enabled": true,
          "pivot_column": "执行状态"
        },
        "difference_formula": "手工数量 - (系统总计 - 已关闭)"
      },
      "timestamp": "2026-01-11 12:00:00"
    }
  ]
}
```

---

## 🔄 同名覆盖

### 机制说明

保存模板时，如果名称已存在，会自动覆盖旧模板。

```
情况1: 新模板
输入: "新模板A"
结果: 创建新模板

情况2: 同名模板
输入: "已存在模板B"
结果: 更新模板B的配置，保留ID
```

### 提示信息

```
模板 "ASN对账-标准模板" 已更新。
```

---

## 📤 导出导入

### 手动备份

复制模板文件即可备份：

```bash
# Windows
copy %APPDATA%\SupplyChain-Reconciler-Plus\templates.json D:\backup\

# macOS/Linux
cp ~/.config/SupplyChain-Reconciler-Plus/templates.json ~/backup/
```

### 恢复模板

将备份文件复制回原位置：

```bash
# Windows
copy D:\backup\templates.json %APPDATA%\SupplyChain-Reconciler-Plus\

# macOS/Linux
cp ~/backup/templates.json ~/.config/SupplyChain-Reconciler-Plus/
```

---

## 💻 API参考

### 保存模板

```python
from utils.storage import save_template

template_id = save_template("模板名称", {
    "key_mappings": [...],
    "value_mapping": {...},
    "difference_formula": "..."
})
```

### 加载模板

```python
from utils.storage import load_template

config = load_template(template_id)
if config:
    panel.set_config(config)
```

### 获取所有模板

```python
from utils.storage import get_all_templates

templates = get_all_templates()
for t in templates:
    print(f"{t['id']}: {t['name']}")
```

### 删除模板

```python
from utils.storage import delete_template

success = delete_template(template_id)
```

---

## 📝 最佳实践

### 1. 命名规范

使用有意义的模板名称：
- ✅ `ASN对账-供应商A`
- ✅ `库存盘点-北京仓`
- ❌ `模板1`
- ❌ `test`

### 2. 定期清理

删除不再使用的模板，保持列表整洁。

### 3. 备份重要模板

重要模板定期备份，防止意外丢失。

### 4. 团队共享

可将templates.json文件分享给团队成员，统一对账配置。

---

## ⚠️ 注意事项

### 1. 列名依赖

模板中的列名必须与实际文件匹配，否则需要重新选择。

### 2. 配置完整性

保存前确保所有必填项都已配置：
- 主键映射（至少1组）
- 数值列映射

### 3. 版本兼容

新版本可能增加配置项，旧模板会使用默认值补充。

---

## ▶️ 下一步

遇到问题？查看 [常见问题](./19-常见问题.md)。
