# 🧮 差值公式

**自定义差值计算详解**

---

## 📋 功能概述

差值公式用于计算手工表与系统表的数量差异，支持自定义计算逻辑。

### 默认公式

```
差值 = 手工数量 - 系统总计
```

### 自定义公式场景

- 排除特定状态的数量
- 只对比部分透视列
- 复杂的计算逻辑

---

## 🎨 界面说明

### 差值公式区域

```
┌─────────────────────────────────────────────────────────────┐
│ 🧮 差值公式                                                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  快速选择: ┌────────────────────────────────────────┐       │
│            │ 手工数量 - 系统总计                   ▼│       │
│            └────────────────────────────────────────┘       │
│                                                             │
│  自定义公式: ┌────────────────────────────────────────┐     │
│              │ 手工数量 - 系统总计                    │     │
│              └────────────────────────────────────────┘     │
│                                                             │
│  可用变量: 手工数量, 系统总计, 已完成, 处理中, 待审核       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 界面元素

| 元素 | 说明 |
|------|------|
| 快速选择 | 预设的常用公式 |
| 自定义公式 | 手动输入公式 |
| 可用变量 | 显示可在公式中使用的变量 |

---

## 📝 可用变量

### 固定变量

| 变量名 | 说明 | 来源 |
|--------|------|------|
| `手工数量` | 手工表聚合后的数值 | 手工表 |
| `系统总计` | 系统表聚合后的总计 | 系统表 |

### 动态变量（透视列）

如果系统表使用了透视，每个透视值都是一个变量：

| 透视列值 | 变量名 |
|---------|--------|
| 已完成 | `已完成` |
| 处理中 | `处理中` |
| 待审核 | `待审核` |
| 已关闭 | `已关闭` |

---

## 📊 公式语法

### 基本运算符

| 运算符 | 含义 | 示例 |
|--------|------|------|
| `+` | 加法 | `A + B` |
| `-` | 减法 | `A - B` |
| `*` | 乘法 | `A * B` |
| `/` | 除法 | `A / B` |
| `()` | 括号 | `(A + B) * C` |

### 公式规则

1. 变量名使用中文，区分大小写
2. 支持括号嵌套
3. 支持加减乘除运算
4. 空格会被忽略

---

## 📝 公式示例

### 示例1: 基本差值

```
公式: 手工数量 - 系统总计

计算: 100 - 95 = 5
```

### 示例2: 排除特定状态

**场景**: 不对账"已关闭"的数量

```
透视结果:
- 已完成: 80
- 已关闭: 20
- 系统总计: 100

公式: 手工数量 - (系统总计 - 已关闭)

计算: 手工数量 - (100 - 20) = 手工数量 - 80
```

### 示例3: 只对比特定状态

**场景**: 只对比"已完成+处理中"

```
透视结果:
- 已完成: 80
- 处理中: 15
- 待审核: 5
- 系统总计: 100

公式: 手工数量 - (已完成 + 处理中)

计算: 手工数量 - (80 + 15) = 手工数量 - 95
```

### 示例4: 排除多个状态

**场景**: 排除"已取消"和"已退货"

```
公式: 手工数量 - (系统总计 - 已取消 - 已退货)
```

### 示例5: 复杂计算

```
公式: 手工数量 - (已完成 + 处理中) * 0.95

说明: 系统数量按95%计算（允许5%损耗）
```

---

## 🚀 快速选择

系统会根据透视配置自动生成快速选择选项：

### 无透视时

```
选项:
- 手工数量 - 系统总计
```

### 有透视时

```
选项:
- 手工数量 - 系统总计
- 手工数量 - (系统总计 - 已完成)
- 手工数量 - (系统总计 - 处理中)
- 手工数量 - (系统总计 - 待审核)
- 手工数量 - (已完成 + 处理中)
...
```

---

## ⚠️ 注意事项

### 1. 变量名必须精确

变量名必须与实际列名完全一致：
- ✅ `已完成`
- ❌ `已 完成`（有空格）
- ❌ `已完成 `（末尾空格）

### 2. 空值处理

如果某透视列值为空（NaN），会被当作 0 处理。

### 3. 除法注意

除法时注意分母不能为0：
```
公式: 手工数量 / 系统总计

当系统总计=0时，结果为 inf（无穷大）
```

### 4. 公式验证

无效公式会使用默认公式：
```
无效公式 → 自动使用: 手工数量 - 系统总计
```

---

## 💻 技术实现

### 配置数据格式

```python
config = {
    "difference_formula": "手工数量 - (系统总计 - 已关闭)"
}
```

### 公式解析

```python
def _calc_diff(df, formula, pivot_values):
    def eval_formula(row):
        expr = formula
        
        # 构建变量字典
        variables = {
            "手工数量": row.get("手工数量", 0) or 0,
            "系统总计": row.get("系统总计", 0) or 0,
        }
        
        # 添加透视列变量
        for pv in pivot_values:
            variables[pv] = row.get(pv, 0) or 0
        
        # 按变量名长度降序替换（避免部分匹配）
        for var_name in sorted(variables.keys(), key=len, reverse=True):
            expr = expr.replace(var_name, str(float(variables[var_name])))
        
        # 安全计算
        if re.match(r'^[\d\s+\-*/().]+$', expr):
            return eval(expr)
        return row["手工数量"] - row["系统总计"]
    
    return df.apply(eval_formula, axis=1)
```

### 安全性

公式计算使用正则验证，只允许：
- 数字
- 运算符 `+ - * / ( )`
- 空格和小数点

禁止执行任意代码。

---

## 📊 公式调试

### 查看计算过程

1. 配置公式
2. 执行对账
3. 在结果预览中查看差值列

### 导出验证

导出Excel后检查：
- 差值列的计算结果
- 与手动计算对比验证

---

## ▶️ 下一步

差值公式配置完成后，了解 [结果导出](./09-结果导出.md)。
