# 🖥️ 主窗口界面

**QtMainWindow 三步骤流程详解**

---

## 📋 界面概述

主窗口采用三步骤流程设计，引导用户完成对账全流程。

### 设计理念

- **渐进式**: 步骤1 → 步骤2 → 步骤3
- **引导式**: 明确的操作提示
- **即时反馈**: 实时预览和状态更新

---

## 🎨 整体布局

```
┌─────────────────────────────────────────────────────────────────────────┐
│  SupplyChain-Reconciler-Plus v1.4.3             [保存模板] [加载模板]  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                     步骤1: 导入文件                                │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │                                                                   │ │
│  │  手工表: [选择文件] test.xlsx    Sheet: [Sheet1 ▼]               │ │
│  │  系统表: [选择文件] system.xlsx  Sheet: [执行报表 ▼]             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                     步骤2: 配置规则                                │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │                                                                   │ │
│  │  [配置面板区域 - 详见 11-配置面板.md]                             │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                     步骤3: 执行与导出                              │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │                                                                   │ │
│  │  [结果预览区域 - 详见 12-结果预览.md]                             │ │
│  │                                                                   │ │
│  │               [🚀 执行对账]    [📥 导出Excel]                     │ │
│  │                                                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│  ✅ 就绪                                                                │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📁 步骤1: 导入文件

### 界面元素

| 元素 | 类型 | 说明 |
|------|------|------|
| 手工表文件按钮 | QPushButton | 点击选择文件 |
| 手工表路径显示 | QLabel | 显示选中的文件名 |
| 手工表Sheet选择 | QComboBox | 选择Sheet |
| 系统表文件按钮 | QPushButton | 点击选择文件 |
| 系统表路径显示 | QLabel | 显示选中的文件名 |
| 系统表Sheet选择 | QComboBox | 选择Sheet |

### 功能特性

- **拖拽导入**: 支持拖拽Excel文件到窗口
- **自动识别**: 自动读取所有Sheet名称
- **默认选择**: 自动选择第一个Sheet
- **打开文件检测**: Windows下可检测已打开的Excel文件

### 文件格式支持

| 格式 | 扩展名 | 说明 |
|------|--------|------|
| Excel 2007+ | .xlsx | 推荐格式 |
| Excel 2003 | .xls | 兼容旧版 |
| Excel启用宏 | .xlsm | 含宏的工作簿 |

---

## 🔧 步骤2: 配置规则

### 可折叠区域

步骤2包含多个可折叠的配置区域：

| 区域 | 默认状态 | 说明 |
|------|---------|------|
| 📑 主键映射 | 展开 | 必填 |
| 📊 数值列映射 | 展开 | 必填 |
| 🧹 数据清洗 | 折叠 | 可选 |
| 🔍 筛选条件 | 折叠 | 可选 |
| 📈 透视配置 | 折叠 | 可选 |
| 🧮 差值公式 | 展开 | 必填 |

### 样例显示

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ▼ 数据样例                                                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  手工表样例 (5行):                                                     │
│  ┌─────────┬──────────┬──────┐                                         │
│  │ 订单编号 │ 物料编码 │ 数量 │                                         │
│  ├─────────┼──────────┼──────┤                                         │
│  │ A001   │ M001    │ 100  │                                         │
│  │ A001   │ M002    │ 50   │                                         │
│  │ ...    │ ...     │ ...  │                                         │
│  └─────────┴──────────┴──────┘                                         │
│                                                                         │
│  系统表样例 (5行):                                                     │
│  ┌─────────┬─────────┬──────────┬──────┐                               │
│  │ 订单号  │ 零件号  │ 订单状态 │ 数量 │                               │
│  ├─────────┼─────────┼──────────┼──────┤                               │
│  │ A001   │ M001   │ 已完成   │ 80   │                               │
│  │ A001   │ M001   │ 处理中   │ 15   │                               │
│  │ ...    │ ...    │ ...     │ ...  │                               │
│  └─────────┴─────────┴──────────┴──────┘                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 步骤3: 执行与导出

### 结果预览

执行对账后显示结果预览：

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ▼ 对账结果预览 (显示前15行)                                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────┬──────┬──────────┬────────┬──────┬────────┐             │
│  │ __KEY__    │已完成│ 系统总计 │手工数量│ 差值 │比对状态│             │
│  ├────────────┼──────┼──────────┼────────┼──────┼────────┤             │
│  │ A001_M001  │  80  │    80   │   80   │   0  │   ✓   │ (绿色背景)   │
│  │ A001_M002  │  50  │    50   │   55   │   5  │   ↕   │ (黄色背景)   │
│  │ A002_M001  │  -   │    -    │  100   │ 100  │   ✗   │ (红色背景)   │
│  └────────────┴──────┴──────────┴────────┴──────┴────────┘             │
│                                                                         │
│  统计: 一致 45 | 差异 12 | 缺失 3 | 共 60 行                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 操作按钮

| 按钮 | 状态 | 说明 |
|------|------|------|
| 🚀 执行对账 | 启用 | 配置完成后可用 |
| 📥 导出Excel | 禁用→启用 | 执行对账后可用 |

---

## 📋 模板管理

### 工具栏

```
┌─────────────────────────────────────────────────────────────────────────┐
│  模板: [选择模板 ▼]  [💾 保存] [📂 加载] [🗑️ 删除]                      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 模板操作

| 操作 | 说明 |
|------|------|
| 保存模板 | 保存当前配置为模板 |
| 加载模板 | 从下拉框选择并加载模板 |
| 删除模板 | 删除当前选中的模板 |

### 模板内容

模板保存以下配置：
- 主键映射
- 数值列映射
- 数据清洗规则
- 筛选条件
- 透视配置
- 差值公式

**不保存**: 文件路径和Sheet选择

---

## 🎨 状态栏

### 状态显示

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ✅ 对账完成: 一致 45 | 差异 12 | 缺失 3                                │
└─────────────────────────────────────────────────────────────────────────┘
```

### 状态类型

| 状态 | 图标 | 说明 |
|------|------|------|
| 就绪 | ✅ | 等待操作 |
| 加载中 | ⏳ | 正在处理 |
| 完成 | ✅ | 操作成功 |
| 错误 | ❌ | 操作失败 |

---

## ⌨️ 快捷操作

### 键盘快捷键

| 快捷键 | 功能 |
|--------|------|
| Ctrl+O | 打开手工表文件 |
| Ctrl+Shift+O | 打开系统表文件 |
| Ctrl+S | 保存模板 |
| Ctrl+E | 执行对账 |
| Ctrl+Shift+E | 导出Excel |

### 鼠标操作

| 操作 | 功能 |
|------|------|
| 双击文件区域 | 打开文件选择 |
| 拖拽文件 | 导入文件 |
| 双击样例表格 | 展开/折叠 |

---

## 🔄 数据流

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ 步骤1    │ ──▶ │ 步骤2    │ ──▶ │ 执行对账 │ ──▶ │ 步骤3    │
│ 导入文件 │     │ 配置规则 │     │ 数据处理 │     │ 结果导出 │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
      │                │                │                │
      ▼                ▼                ▼                ▼
  读取Excel      构建配置对象      调用CompareEngine    显示预览
  解析Sheet      验证必填项       合并比对计算        导出Excel
```

---

## 💻 技术实现

### 核心类

```python
# ui/qt_main_window.py
class QtMainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self._init_ui()
        self._connect_signals()
    
    def _init_ui(self):
        # 创建步骤区域
        self._create_step1_file_import()
        self._create_step2_config_panel()
        self._create_step3_result_area()
    
    def _on_run_compare(self):
        # 执行对账逻辑
        config = self.config_panel.get_config()
        result = CompareEngine.merge_and_compare(...)
        self.result_preview.set_data(result)
```

### 信号连接

```python
# 文件导入信号
self.btn_manual_file.clicked.connect(self._on_select_manual_file)
self.btn_system_file.clicked.connect(self._on_select_system_file)
self.combo_manual_sheet.currentTextChanged.connect(self._on_manual_sheet_changed)
self.combo_system_sheet.currentTextChanged.connect(self._on_system_sheet_changed)

# 执行和导出信号
self.btn_run.clicked.connect(self._on_run_compare)
self.btn_export.clicked.connect(self._on_export)
```

### 相关文件

| 文件 | 说明 |
|------|------|
| `ui/qt_main_window.py` | 主窗口实现 |
| `ui/qt_config_panel.py` | 配置面板 |
| `ui/qt_result_preview.py` | 结果预览 |
| `main.py` | 应用入口 |

---

## ▶️ 下一步

详细了解配置面板，查看 [配置面板](./11-配置面板.md)。
