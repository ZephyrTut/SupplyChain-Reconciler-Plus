# 📂 数据导入功能

**Excel文件导入与Sheet选择详解**

---

## 📋 功能概述

数据导入是对账的第一步，支持从Excel文件导入手工表和系统表数据。

### 支持的文件格式

| 格式 | 扩展名 | 引擎 | 说明 |
|------|--------|------|------|
| Excel 2007+ | `.xlsx` | openpyxl | 推荐格式 |
| Excel 97-2003 | `.xls` | xlrd | 旧版格式 |
| Excel宏文件 | `.xlsm` | openpyxl | 带宏的文件 |

---

## 🎨 界面说明

### 文件导入卡片

每个文件导入区域包含：

```
┌─────────────────────────────────────┐
│            📁                       │
│         手工表文件                   │
│    拖拽文件到此处或点击选择          │
│                                     │
│       未选择文件                     │
│    ┌─────────────────┐              │
│    │  选择文件        │              │
│    └─────────────────┘              │
└─────────────────────────────────────┘
```

### 导入成功状态

```
┌─────────────────────────────────────┐
│            📁                       │
│         手工表文件                   │
│    拖拽文件到此处或点击选择          │
│                                     │
│    ✓ 订单数据.xlsx                  │
│    ┌─────────────────┐              │
│    │ Sheet1      ▼   │  ← Sheet选择  │
│    └─────────────────┘              │
│    ┌─────────────────┐              │
│    │  选择文件        │              │
│    └─────────────────┘              │
└─────────────────────────────────────┘
```

---

## 📥 导入方式

### 方式一: 点击选择

1. 点击「选择文件」按钮
2. 在文件对话框中选择Excel文件
3. 点击「打开」

### 方式二: 拖拽导入

1. 从文件管理器拖拽Excel文件
2. 拖到文件卡片区域
3. 松开鼠标完成导入

### 方式三: 活动Excel导入（仅Windows）

1. 在Excel中打开目标文件
2. 点击「📊 活动Excel」按钮
3. 自动检测并导入当前打开的工作簿

⚠️ **注意**: 需要安装 `pywin32` 库

---

## 📑 Sheet选择

### 单Sheet文件

如果Excel只有一个Sheet，自动使用该Sheet，不显示下拉框。

### 多Sheet文件

如果Excel有多个Sheet：
1. 导入后自动显示Sheet下拉框
2. 从下拉框选择目标Sheet
3. 切换Sheet会重新加载数据

### Sheet选择注意事项

- 💡 下拉框显示所有Sheet名称
- 💡 默认选中第一个Sheet
- 💡 切换Sheet后数据和列会更新
- ⚠️ 选择空Sheet会导致无数据

---

## 🔍 数据加载细节

### 自动检测表头

系统会自动检测表头行位置：
- 扫描前20行
- 寻找非空且有效的表头
- 自动跳过标题行和空行

### 数据清理

加载时自动执行：
1. **去除列名空格**: 列名前后空格被移除
2. **去除空行**: 全空的行被删除
3. **类型推断**: 自动推断列数据类型

### 加载参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| header_row | 自动检测 | 表头所在行 |
| skip_rows | 0 | 跳过的行数 |
| max_scan_rows | 20 | 表头检测最大扫描行 |

---

## 📊 数据预览

导入成功后，右侧面板显示数据样例：

### 手工表样例（蓝色区域）

```
┌──────────────────────────────────────┐
│ ▼ 📋 手工表样例                      │
├──────────────────────────────────────┤
│ 订单号  │ 物料   │ 数量  │ 状态     │
│ A001   │ M001  │ 100  │ 已审核   │
│ A002   │ M002  │ 200  │ 已审核   │
│ A003   │ M003  │ 150  │ 待审核   │
├──────────────────────────────────────┤
│ 共 100 行，5 列                       │
└──────────────────────────────────────┘
```

### 系统表样例（绿色区域）

```
┌──────────────────────────────────────┐
│ ▼ 📋 系统表样例                      │
├──────────────────────────────────────┤
│ 订单号  │ 物料   │ 数量  │ 状态     │
│ A001   │ M001  │ 95   │ 已完成   │
│ A002   │ M002  │ 200  │ 已完成   │
│ A004   │ M004  │ 300  │ 处理中   │
├──────────────────────────────────────┤
│ 共 120 行，5 列                       │
└──────────────────────────────────────┘
```

---

## ⚠️ 常见问题

### 问题1: 文件无法打开

**可能原因**:
- 文件被其他程序占用
- 文件损坏
- 格式不支持

**解决方案**:
- 关闭Excel再导入
- 检查文件是否能在Excel中正常打开
- 另存为xlsx格式重试

### 问题2: 列名显示异常

**可能原因**:
- 表头行检测错误
- 存在合并单元格

**解决方案**:
- 确保表头在第一行
- 取消合并单元格后重新导入

### 问题3: 数据行数不对

**可能原因**:
- 空行被过滤
- 表头行识别错误

**解决方案**:
- 检查原始文件数据
- 删除多余空行后重新导入

---

## 💻 技术实现

### 相关代码文件

| 文件 | 说明 |
|------|------|
| `ui/qt_main_window.py` | FileDropCard 组件 |
| `utils/excel_utils.py` | Excel读取函数 |
| `utils/excel_detection.py` | 活动Excel检测 |

### 核心函数

```python
# 获取Sheet列表
from utils.excel_utils import get_sheet_names
sheets = get_sheet_names(file_path)

# 加载Excel数据
from utils.excel_utils import load_excel
df = load_excel(file_path, sheet_name="Sheet1")

# 检测活动Excel (Windows)
from utils.excel_detection import get_active_excel
info = get_active_excel()
# 返回: {'path': '...', 'name': '...', 'sheet_name': '...'}
```

---

## ▶️ 下一步

文件导入完成后，继续配置 [主键映射](./04-主键配置.md)。
