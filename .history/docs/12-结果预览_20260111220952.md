# ğŸ“‹ ç»“æœé¢„è§ˆ

**QtResultPreview ç»„ä»¶è¯¦è§£**

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç»“æœé¢„è§ˆç»„ä»¶ç”¨äºæ˜¾ç¤ºå¯¹è´¦ç»“æœï¼Œæä¾›è¡¨æ ¼è§†å›¾å’Œç»Ÿè®¡ä¿¡æ¯ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… è¡¨æ ¼é¢„è§ˆï¼ˆå‰15è¡Œï¼‰
- âœ… è¡Œé¢œè‰²æ ‡è®°
- âœ… ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
- âœ… å¯æŠ˜å å±•ç¤º

---

## ğŸ¨ ç•Œé¢å¸ƒå±€

### å®Œæ•´å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ ğŸ“Š å¯¹è´¦ç»“æœé¢„è§ˆ (æ˜¾ç¤ºå‰15è¡Œ)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ __KEY__      â”‚ å·²å®Œæˆ â”‚ å¤„ç†ä¸­ â”‚ ç³»ç»Ÿæ€»è®¡ â”‚ æ‰‹å·¥æ•°é‡ â”‚ å·®å€¼ â”‚ çŠ¶æ€ â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ A001_M001   â”‚   80   â”‚   15   â”‚    95   â”‚    95   â”‚   0  â”‚  âœ“  â”‚  â”‚ â† æµ…ç»¿
â”‚  â”‚ A001_M002   â”‚   50   â”‚    0   â”‚    50   â”‚    55   â”‚   5  â”‚  â†•  â”‚  â”‚ â† æµ…é»„
â”‚  â”‚ A002_M001   â”‚   -    â”‚    -   â”‚     -   â”‚   100   â”‚ 100  â”‚  âœ—  â”‚  â”‚ â† æµ…çº¢
â”‚  â”‚ A003_M001   â”‚  200   â”‚   10   â”‚   210   â”‚   200   â”‚ -10  â”‚  â†•  â”‚  â”‚ â† æµ…è“
â”‚  â”‚ ...         â”‚  ...   â”‚  ...   â”‚   ...   â”‚   ...   â”‚ ...  â”‚ ... â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“Š ç»Ÿè®¡: ä¸€è‡´ 45 | å·®å¼‚ 12 | ç¼ºå¤± 3 | å…± 60 è¡Œ                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶è¯´æ˜

| ç»„ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| æ ‡é¢˜æ  | QLabel | æ˜¾ç¤ºåŒºåŸŸæ ‡é¢˜ |
| ç»“æœè¡¨æ ¼ | QTableWidget | æ˜¾ç¤ºå¯¹è´¦æ•°æ® |
| ç»Ÿè®¡æ  | QLabel | æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ |

---

## ğŸ“Š è¡¨æ ¼ç»“æ„

### åˆ—é¡ºåº

| åºå· | åˆ—å | è¯´æ˜ |
|------|------|------|
| 1 | __KEY__ | å¤åˆä¸»é”® |
| 2~N | é€è§†åˆ— | ç³»ç»Ÿè¡¨é€è§†å€¼ï¼ˆæŒ‰å­—æ¯æ’åºï¼‰ |
| N+1 | ç³»ç»Ÿæ€»è®¡ | ç³»ç»Ÿè¡¨èšåˆå€¼ |
| N+2 | æ‰‹å·¥æ•°é‡ | æ‰‹å·¥è¡¨èšåˆå€¼ |
| N+3 | å·®å€¼ | è®¡ç®—çš„å·®å€¼ |
| N+4 | æ¯”å¯¹çŠ¶æ€ | çŠ¶æ€ç¬¦å· |

### çŠ¶æ€ç¬¦å·

| ç¬¦å· | å«ä¹‰ | é¢œè‰² |
|------|------|------|
| âœ“ | ä¸€è‡´ | æµ…ç»¿è‰² #D1FAE5 |
| â†• | å·®å¼‚(æ­£) | æµ…é»„è‰² #D9F99D |
| â†• | å·®å¼‚(è´Ÿ) | æµ…è“è‰² #BFDBFE |
| âœ— | ç¼ºå¤± | æµ…çº¢è‰² #FECACA |

---

## ğŸ¨ é¢œè‰²æ ‡è®°

### è¡ŒèƒŒæ™¯è‰²

```python
PREVIEW_COLORS = {
    "match": "#D1FAE5",      # ä¸€è‡´ - æµ…ç»¿
    "diff_pos": "#D9F99D",   # å·®å¼‚(æ­£) - æµ…é»„
    "diff_neg": "#BFDBFE",   # å·®å¼‚(è´Ÿ) - æµ…è“
    "missing": "#FECACA",    # ç¼ºå¤± - æµ…çº¢
}
```

### é¢œè‰²é€»è¾‘

```python
def _get_row_color(row):
    status = row.get("æ¯”å¯¹çŠ¶æ€", "")
    diff = row.get("å·®å€¼", 0)
    
    if "âœ“" in status:
        return PREVIEW_COLORS["match"]
    elif "âœ—" in status:
        return PREVIEW_COLORS["missing"]
    elif diff > 0:
        return PREVIEW_COLORS["diff_pos"]
    else:
        return PREVIEW_COLORS["diff_neg"]
```

---

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

### æ˜¾ç¤ºæ ¼å¼

```
ğŸ“Š ç»Ÿè®¡: ä¸€è‡´ 45 | å·®å¼‚ 12 | ç¼ºå¤± 3 | å…± 60 è¡Œ
```

### ç»Ÿè®¡é¡¹

| é¡¹ç›® | è®¡ç®—æ–¹å¼ |
|------|---------|
| ä¸€è‡´ | å·®å€¼=0 çš„è¡Œæ•° |
| å·®å¼‚ | å·®å€¼â‰ 0 ä¸”åŒæ–¹éƒ½æœ‰æ•°æ®çš„è¡Œæ•° |
| ç¼ºå¤± | ä»…å•æ–¹æœ‰æ•°æ®çš„è¡Œæ•° |
| å…±è®¡ | æ€»è¡Œæ•° |

### ç™¾åˆ†æ¯”æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰

```
ğŸ“Š ç»Ÿè®¡: ä¸€è‡´ 45 (75%) | å·®å¼‚ 12 (20%) | ç¼ºå¤± 3 (5%) | å…± 60 è¡Œ
```

---

## ğŸ” é¢„è§ˆé™åˆ¶

### è¡Œæ•°é™åˆ¶

é»˜è®¤åªæ˜¾ç¤ºå‰15è¡Œï¼Œé¿å…å¤§æ•°æ®é‡å¯¼è‡´UIå¡é¡¿ã€‚

```python
PREVIEW_ROW_LIMIT = 15

preview_df = result_df.head(PREVIEW_ROW_LIMIT)
```

### åˆ—å®½è‡ªé€‚åº”

```python
table.resizeColumnsToContents()
table.horizontalHeader().setStretchLastSection(True)
```

---

## ğŸ’» æŠ€æœ¯å®ç°

### æ ¸å¿ƒç±»

```python
# ui/qt_result_preview.py
class QtResultPreview(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self._init_ui()
        self._result_df = None
    
    def _init_ui(self):
        layout = QVBoxLayout(self)
        
        # æ ‡é¢˜
        self.title_label = QLabel("ğŸ“Š å¯¹è´¦ç»“æœé¢„è§ˆ (æ˜¾ç¤ºå‰15è¡Œ)")
        
        # è¡¨æ ¼
        self.table = QTableWidget()
        self.table.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)
        
        # ç»Ÿè®¡
        self.stats_label = QLabel()
        
        layout.addWidget(self.title_label)
        layout.addWidget(self.table)
        layout.addWidget(self.stats_label)
    
    def set_data(self, df: pd.DataFrame, pivot_values: list = None):
        """è®¾ç½®é¢„è§ˆæ•°æ®"""
        self._result_df = df
        self._pivot_values = pivot_values or []
        self._refresh_table()
        self._update_stats()
    
    def _refresh_table(self):
        """åˆ·æ–°è¡¨æ ¼æ˜¾ç¤º"""
        if self._result_df is None:
            return
        
        preview_df = self._result_df.head(15)
        
        # è®¾ç½®è¡Œåˆ—
        self.table.setRowCount(len(preview_df))
        self.table.setColumnCount(len(preview_df.columns))
        self.table.setHorizontalHeaderLabels(preview_df.columns.tolist())
        
        # å¡«å……æ•°æ®
        for i, (_, row) in enumerate(preview_df.iterrows()):
            color = self._get_row_color(row)
            for j, val in enumerate(row):
                item = QTableWidgetItem(str(val))
                item.setBackground(QColor(color))
                self.table.setItem(i, j, item)
    
    def _update_stats(self):
        """æ›´æ–°ç»Ÿè®¡ä¿¡æ¯"""
        if self._result_df is None:
            return
        
        total = len(self._result_df)
        match_count = len(self._result_df[self._result_df["å·®å€¼"] == 0])
        missing_count = len(self._result_df[self._result_df["æ¯”å¯¹çŠ¶æ€"].str.contains("âœ—")])
        diff_count = total - match_count - missing_count
        
        self.stats_label.setText(
            f"ğŸ“Š ç»Ÿè®¡: ä¸€è‡´ {match_count} | å·®å¼‚ {diff_count} | "
            f"ç¼ºå¤± {missing_count} | å…± {total} è¡Œ"
        )
    
    def get_result(self) -> pd.DataFrame:
        """è·å–å®Œæ•´ç»“æœ"""
        return self._result_df
    
    def clear(self):
        """æ¸…ç©ºé¢„è§ˆ"""
        self._result_df = None
        self.table.setRowCount(0)
        self.stats_label.setText("")
```

### è¡¨æ ¼æ ·å¼

```python
# è®¾ç½®è¡¨æ ¼æ ·å¼
self.table.setStyleSheet("""
    QTableWidget {
        background-color: #ffffff;
        border: 1px solid #cccccc;
        gridline-color: #e0e0e0;
    }
    QTableWidget::item {
        padding: 4px 8px;
    }
    QHeaderView::section {
        background-color: #f5f5f5;
        border: 1px solid #cccccc;
        padding: 4px;
        font-weight: bold;
    }
""")

# ç¦æ­¢ç¼–è¾‘
self.table.setEditTriggers(QTableWidget.EditTrigger.NoEditTriggers)

# é€‰æ‹©æ•´è¡Œ
self.table.setSelectionBehavior(QTableWidget.SelectionBehavior.SelectRows)
```

---

## ğŸ”Œ ç»„ä»¶æ¥å£

### å…¬å¼€æ–¹æ³•

| æ–¹æ³• | å‚æ•° | è¯´æ˜ |
|------|------|------|
| `set_data()` | df, pivot_values | è®¾ç½®é¢„è§ˆæ•°æ® |
| `get_result()` | - | è·å–å®Œæ•´ç»“æœDataFrame |
| `clear()` | - | æ¸…ç©ºé¢„è§ˆ |
| `get_stats()` | - | è·å–ç»Ÿè®¡ä¿¡æ¯å­—å…¸ |

### ä½¿ç”¨ç¤ºä¾‹

```python
# è®¾ç½®æ•°æ®
preview.set_data(result_df, pivot_values=["å·²å®Œæˆ", "å¤„ç†ä¸­"])

# è·å–ç»“æœ
full_result = preview.get_result()

# è·å–ç»Ÿè®¡
stats = preview.get_stats()
# {"total": 60, "match": 45, "diff": 12, "missing": 3}

# æ¸…ç©º
preview.clear()
```

---

## ğŸ¯ äº¤äº’åŠŸèƒ½

### ç‚¹å‡»è¡Œé«˜äº®

```python
self.table.itemSelectionChanged.connect(self._on_row_selected)

def _on_row_selected(self):
    selected = self.table.selectedItems()
    if selected:
        row = selected[0].row()
        # å¯æ‰©å±•ï¼šæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
```

### åŒå‡»å¤åˆ¶

```python
self.table.itemDoubleClicked.connect(self._on_item_double_click)

def _on_item_double_click(self, item):
    QApplication.clipboard().setText(item.text())
```

---

## â–¶ï¸ ä¸‹ä¸€æ­¥

äº†è§£å¯¹è¯æ¡†ç»„ä»¶ï¼ŒæŸ¥çœ‹ [å¯¹è¯æ¡†ç»„ä»¶](./13-å¯¹è¯æ¡†ç»„ä»¶.md)ã€‚
