# SupplyChain-Reconciler-Plus v1.4.2 æ›´æ–°è¯´æ˜

**å‘å¸ƒæ—¥æœŸ**: 2026å¹´1æœˆ8æ—¥

---

## ğŸ¯ æœ¬æ¬¡æ›´æ–°é‡ç‚¹

æœ¬æ¬¡æ›´æ–°ä»å†å²ç‰ˆæœ¬ (result_preview_20251217233112.py, main_window_20251218000744.py) ä¸­æå–äº†**å…¬å¼æ˜¾ç¤ºã€åˆ—å­—æ¯æ˜ å°„å’Œæ•°æ®é¢„è§ˆ**å®Œæ•´é€»è¾‘ï¼Œå¹¶è¿ç§»åˆ° PyQt6 æ¡†æ¶ï¼Œç¡®ä¿ï¼š

1. **åˆ—é¡ºåºä¸€è‡´æ€§**: é¢„è§ˆã€ç»“æœè¡¨æ ¼ã€å¯¼å‡ºExcelä¸‰è€…åˆ—é¡ºåºå®Œå…¨ä¸€è‡´
2. **å…¬å¼æ˜¾ç¤º**: åŒæ—¶æ˜¾ç¤ºExcelåˆ—å­—æ¯å…¬å¼å’ŒåŸå§‹å…¬å¼
3. **å…³è”æ€§**: æ­¥éª¤2é¢„è§ˆã€æ­¥éª¤3ç»“æœã€Excelå¯¼å‡ºä¸‰è€…æ•°æ®æ ¼å¼ç»Ÿä¸€

---

## âœ¨ æ–°å¢åŠŸèƒ½

### 1. ç»Ÿä¸€çš„åˆ—é¡ºåºç³»ç»Ÿ

æ‰€æœ‰æ•°æ®æ˜¾ç¤ºå’Œå¯¼å‡ºéƒ½ä½¿ç”¨ç›¸åŒçš„åˆ—é¡ºåºï¼š
```
__KEY__ â†’ é€è§†åˆ—(æŒ‰å­—æ¯æ’åº) â†’ ç³»ç»Ÿæ€»è®¡ â†’ æ‰‹å·¥æ•°é‡ â†’ å·®å€¼ â†’ æ¯”å¯¹çŠ¶æ€
```

#### ç¤ºä¾‹ï¼ˆ3ä¸ªé€è§†åˆ—åœºæ™¯ï¼‰
```
| KEY         | A (å·²å®Œæˆ) | B (å¤„ç†ä¸­) | C (å¾…å®¡æ ¸) | D (ç³»ç»Ÿæ€»è®¡) | E (æ‰‹å·¥æ•°é‡) | å·®å€¼ | æ¯”å¯¹çŠ¶æ€ |
```

### 2. å®Œæ•´çš„å…¬å¼æ˜¾ç¤ºç³»ç»Ÿ

#### 2.1 åˆ—å­—æ¯è‡ªåŠ¨åˆ†é…
- **Excelé£æ ¼åˆ—å­—æ¯**: è‡ªåŠ¨ä¸ºæ¯åˆ—åˆ†é…å­—æ¯ (A, B, C, ... Z, AA, AB, ...)
- **è·³è¿‡ç‰¹æ®Šåˆ—**: __KEY__ã€å·®å€¼ã€æ¯”å¯¹çŠ¶æ€ä¸åˆ†é…å­—æ¯
- **åˆ†é…é¡ºåº**: 
  1. é€è§†åˆ—ï¼ˆæŒ‰å­—æ¯é¡ºåºæ’åˆ—ï¼‰
  2. ç³»ç»Ÿæ€»è®¡
  3. æ‰‹å·¥æ•°é‡

#### 2.2 å…¬å¼æ˜¾ç¤ºåŒºåŸŸ

**æ­¥éª¤2 - æ•°æ®é¢„è§ˆ**:
```
å·®å€¼å…¬å¼: E - (D - A)  (åŸå§‹: M - (S - å·²å®Œæˆ))
åˆ—å¯¹ç…§: A=å·²å®Œæˆ, B=å¤„ç†ä¸­, C=å¾…å®¡æ ¸, D=ç³»ç»Ÿæ€»è®¡, E=æ‰‹å·¥æ•°é‡
```

**æ­¥éª¤3 - ç»“æœè¡¨æ ¼**:
```
å·®å€¼å…¬å¼: E - (D - A)  (åŸå§‹: M - (S - å·²å®Œæˆ))
åˆ—å¯¹ç…§: A=å·²å®Œæˆ, B=å¤„ç†ä¸­, C=å¾…å®¡æ ¸, D=ç³»ç»Ÿæ€»è®¡, E=æ‰‹å·¥æ•°é‡
```

#### 2.3 å­—æ®µæ˜ å°„è¯´æ˜
```
å­—æ®µæ˜ å°„: KEY = è®¢å•ç¼–å· + ç‰©æ–™ç¼–ç  | A = å·²å®Œæˆ | B = å¤„ç†ä¸­ | E = æ‰‹å·¥æ•°é‡ | D = ç³»ç»Ÿæ€»è®¡
```

### 3. æ–°å¢ `update_result_preview` æ–¹æ³•

æ­¥éª¤2ç°åœ¨æ”¯æŒæ˜¾ç¤ºå¯¹è´¦è®¡ç®—åçš„ç»“æœï¼ˆè€Œä¸æ˜¯åªæ˜¾ç¤ºåŸå§‹æ•°æ®ï¼‰ï¼š

```python
# è°ƒç”¨ç¤ºä¾‹
result_preview.update_result_preview(
    result_df=è®¡ç®—åçš„å¯¹è´¦ç»“æœ,
    pivot_values=é€è§†å€¼åˆ—è¡¨,
    config=é…ç½®å­—å…¸,
    manual_df=æ‰‹å·¥è¡¨åŸå§‹æ•°æ®,
    system_df=ç³»ç»Ÿè¡¨åŸå§‹æ•°æ®
)
```

### 4. å¢å¼ºçš„è¡¨å¤´æ˜¾ç¤º

è¡¨å¤´ç»Ÿä¸€ä½¿ç”¨å­—æ¯æ ‡æ³¨æ ¼å¼ï¼š
```
[ä¹‹å‰] æ‰‹å·¥æ•°é‡ | å·²å®Œæˆ | å¤„ç†ä¸­ | ç³»ç»Ÿæ€»è®¡
[ç°åœ¨] E (æ‰‹å·¥æ•°é‡) | A (å·²å®Œæˆ) | B (å¤„ç†ä¸­) | D (ç³»ç»Ÿæ€»è®¡)
```

### 5. æ•°å€¼æ ¼å¼åŒ–

- æ•´æ•°ï¼šæ˜¾ç¤ºä¸ºæ•´æ•°ï¼ˆ100 è€Œé 100.00ï¼‰
- å°æ•°ï¼šä¿ç•™2ä½æœ‰æ•ˆæ•°å­—å¹¶å»é™¤å°¾é›¶ï¼ˆ1.5 è€Œé 1.50ï¼‰
- ç©ºå€¼ï¼šæ˜¾ç¤ºä¸ºç©ºå­—ç¬¦ä¸²

---

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

### ä»£ç è¿ç§»æ¥æº

ä»ä»¥ä¸‹å†å²æ–‡ä»¶æå–é€»è¾‘ï¼š
- `.history/ui/result_preview_20251217233112.py` - å…¬å¼æ˜¾ç¤ºã€åˆ—å­—æ¯æ˜ å°„
- `.history/ui/main_window_20251218000744.py` - é¢„è§ˆæ•°æ®è®¡ç®—æµç¨‹

### å…³é”®æ–¹æ³•

#### 1. `_excel_col_letter(n)` - åˆ—å­—æ¯ç”Ÿæˆ
```python
def _excel_col_letter(self, n: int) -> str:
    """ç”ŸæˆExcelåˆ—å­—æ¯ï¼ˆA, B, C, ... Z, AA, AB, ...ï¼‰"""
    result = ""
    while n >= 0:
        result = chr(n % 26 + 65) + result
        n = n // 26 - 1
    return result
```

#### 2. `_get_export_columns()` - ç»Ÿä¸€åˆ—é¡ºåº
```python
def _get_export_columns(self, df: pd.DataFrame, pivot_values: List[str]) -> List[str]:
    """è·å–å¯¼å‡ºåˆ—é¡ºåºï¼ˆä¸å¯¼å‡ºå¼•æ“ä¸€è‡´ï¼‰"""
    cols = []
    if "__KEY__" in df.columns: cols.append("__KEY__")
    for pv in sorted(pivot_values):
        if pv in df.columns: cols.append(pv)
    if "ç³»ç»Ÿæ€»è®¡" in df.columns: cols.append("ç³»ç»Ÿæ€»è®¡")
    if "æ‰‹å·¥æ•°é‡" in df.columns: cols.append("æ‰‹å·¥æ•°é‡")
    if "å·®å€¼" in df.columns: cols.append("å·®å€¼")
    if "æ¯”å¯¹çŠ¶æ€" in df.columns: cols.append("æ¯”å¯¹çŠ¶æ€")
    return cols if cols else list(df.columns)
```

#### 3. `_update_formula_display()` - å…¬å¼æ˜¾ç¤º
- ä½¿ç”¨æ­£åˆ™ `\bM\b` å’Œ `\bS\b` æ›¿æ¢å˜é‡ä¸ºåˆ—å­—æ¯
- é€è§†åˆ—ä½¿ç”¨ `re.escape()` è½¬ä¹‰ååŒ¹é…

#### 4. `get_column_letters()` - è·å–åˆ—å­—æ¯æ˜ å°„
å…è®¸å¤–éƒ¨ç»„ä»¶è·å–åˆ—å­—æ¯æ˜ å°„ï¼Œç”¨äºåŒæ­¥é…ç½®é¢æ¿ã€‚

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### ui/qt_result_preview.py

#### QtResultPreview ç±»ï¼ˆæ­¥éª¤2é¢„è§ˆï¼‰
- **æ–°å¢**: `_get_export_columns()` - ç»Ÿä¸€åˆ—é¡ºåº
- **æ–°å¢**: `update_result_preview()` - æ˜¾ç¤ºå¯¹è´¦ç»“æœ
- **æ–°å¢**: `_fill_result_table()` - å¡«å……å¸¦é¢œè‰²çš„ç»“æœè¡¨æ ¼
- **æ–°å¢**: `_get_status_colors()` - çŠ¶æ€é¢œè‰²æ˜ å°„
- **æ–°å¢**: `get_column_letters()` - è·å–åˆ—å­—æ¯æ˜ å°„
- **ä¿®æ”¹**: `_setup_ui()` - æ–°å¢å…¬å¼æ˜¾ç¤ºåŒºåŸŸ
- **ä¿®æ”¹**: `clear()` - æ¸…ç©ºå…¬å¼æ˜¾ç¤º

#### QtResultTable ç±»ï¼ˆæ­¥éª¤3ç»“æœï¼‰
- **æ–°å¢**: `_get_export_columns()` - ç»Ÿä¸€åˆ—é¡ºåº
- **ä¿®æ”¹**: `set_data()` - ä½¿ç”¨æ­£ç¡®çš„åˆ—é¡ºåºå’Œå­—æ¯æ˜ å°„
- **ä¿®æ”¹**: `_setup_ui()` - å…¬å¼æ˜¾ç¤ºåŒºåŸŸ
- **ä¿®æ”¹**: `_update_formula_display()` - å…¬å¼æ˜¾ç¤ºé€»è¾‘

### ui/qt_main_window.py
- **ä¿®æ”¹**: `_execute_compare()` - ä¼ é€’ config å‚æ•°åˆ° result_table.set_data()

---

## ğŸ“Š å…³è”æ€§è¯´æ˜

### ä¸‰å¤„æ•°æ®æ˜¾ç¤ºçš„ä¸€è‡´æ€§

| ä½ç½® | ç»„ä»¶ | åˆ—é¡ºåº | åˆ—å­—æ¯ | å…¬å¼æ˜¾ç¤º |
|------|------|--------|--------|----------|
| æ­¥éª¤2 | QtResultPreview | âœ… ç»Ÿä¸€ | âœ… ä¸€è‡´ | âœ… æœ‰ |
| æ­¥éª¤3 | QtResultTable | âœ… ç»Ÿä¸€ | âœ… ä¸€è‡´ | âœ… æœ‰ |
| å¯¼å‡º | ExportEngine | âœ… ç»Ÿä¸€ | N/A | N/A |

### åˆ—å­—æ¯æ˜ å°„æµç¨‹

```
1. é…ç½®å®Œæˆ â†’ ç”Ÿæˆ pivot_values
                    â†“
2. è°ƒç”¨ _get_export_columns() ç¡®å®šåˆ—é¡ºåº
                    â†“
3. æŒ‰é¡ºåºåˆ†é…åˆ—å­—æ¯ï¼ˆè·³è¿‡KEY/å·®å€¼/çŠ¶æ€ï¼‰
                    â†“
4. å­˜å‚¨åˆ° column_letters å­—å…¸
                    â†“
5. ç”¨äºå…¬å¼æ˜¾ç¤ºã€è¡¨å¤´æ˜¾ç¤º
```

### å…¬å¼å˜é‡æ›¿æ¢æµç¨‹

```
åŸå§‹å…¬å¼: M - (S - å·²å®Œæˆ)
           â†“ æ›¿æ¢ M â†’ Eï¼ˆæ‰‹å·¥æ•°é‡åˆ—å­—æ¯ï¼‰
           â†“ æ›¿æ¢ S â†’ Dï¼ˆç³»ç»Ÿæ€»è®¡åˆ—å­—æ¯ï¼‰
           â†“ æ›¿æ¢ "å·²å®Œæˆ" â†’ Aï¼ˆé€è§†åˆ—å­—æ¯ï¼‰
æ˜¾ç¤ºå…¬å¼: E - (D - A)
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•ç”¨ä¾‹1: æ— é€è§†åˆ—
- **å…¬å¼**: `M - S`
- **é¢„æœŸåˆ—é¡ºåº**: KEY | A(ç³»ç»Ÿæ€»è®¡) | B(æ‰‹å·¥æ•°é‡) | å·®å€¼ | çŠ¶æ€
- **é¢„æœŸå…¬å¼**: `B - A (M - S)`

### æµ‹è¯•ç”¨ä¾‹2: å•é€è§†åˆ—
- **é€è§†åˆ—**: å·²å®Œæˆ
- **å…¬å¼**: `M - (S - å·²å®Œæˆ)`
- **é¢„æœŸåˆ—é¡ºåº**: KEY | A(å·²å®Œæˆ) | B(ç³»ç»Ÿæ€»è®¡) | C(æ‰‹å·¥æ•°é‡) | å·®å€¼ | çŠ¶æ€
- **é¢„æœŸå…¬å¼**: `C - (B - A) (M - (S - å·²å®Œæˆ))`

### æµ‹è¯•ç”¨ä¾‹3: å¤šé€è§†åˆ—
- **é€è§†åˆ—**: å·²å®Œæˆã€å¤„ç†ä¸­ã€å¾…å®¡æ ¸
- **å…¬å¼**: `M - (A + B + C)`ï¼ˆä½¿ç”¨é€è§†åˆ—åï¼‰
- **é¢„æœŸåˆ—é¡ºåº**: KEY | A(å¾…å®¡æ ¸) | B(å¤„ç†ä¸­) | C(å·²å®Œæˆ) | D(ç³»ç»Ÿæ€»è®¡) | E(æ‰‹å·¥æ•°é‡) | å·®å€¼ | çŠ¶æ€
- **æ³¨æ„**: é€è§†åˆ—æŒ‰å­—æ¯æ’åºï¼Œæ‰€ä»¥"å¾…å®¡æ ¸"æ’åœ¨æœ€å‰

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **å®Œæ•´é¡¹ç›®æ–‡æ¡£**: [PROJECT_OVERVIEW.md](PROJECT_OVERVIEW.md)
- **å¼€å‘çº¦æŸ**: [.github/copilot-instructions.md](.github/copilot-instructions.md)
- **å†å²ç‰ˆæœ¬å‚è€ƒ**: `.history/ui/result_preview_20251217233112.py`

---

**æ›´æ–°äººå‘˜**: GitHub Copilot (Claude Opus 4.5)  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.1

