# SupplyChain-Reconciler-Plus 项目文档

**供应链智能对账系统** - Python桌面应用  
**当前版本**: v1.4.3  
**最后更新**: 2026年1月11日

---

##  目录
- [项目概述](#项目概述)
- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [核心功能](#核心功能)
- [安装与运行](#安装与运行)
- [使用指南](#使用指南)
- [开发说明](#开发说明)

---

## 项目概述

SupplyChain-Reconciler-Plus 是一个基于Python的供应链对账桌面应用，专为企业财务和供应链部门设计，用于快速比对手工表与系统表的数据差异。

### 应用场景
- 库存对账（手工盘点 vs ERP系统）
- 订单核对（手工记录 vs 订单系统）
- 财务对账（人工账目 vs 财务系统）
- ASN送货单对账（到货单 vs 系统执行报表）
- 任何需要双表数据比对的场景

### 核心优势
-  **零代码配置**: 图形界面完成所有配置，无需编程
-  **复合主键**: 支持多字段组合主键
-  **双向透视**: 手工表和系统表均支持透视聚合
-  **出入库区分**: 手工表透视支持区分出库/入库方向
-  **数据清洗**: 支持正则表达式批量清洗列数据
-  **灵活筛选**: 支持多种筛选操作符（等于、包含、包含于等）
-  **自定义公式**: 灵活配置差值计算公式
-  **模板管理**: 保存常用配置，一键应用
-  **实时预览**: 配置即时生效，所见即所得
-  **彩色导出**: Excel结果自动标色（一致/差异/缺失）
-  **多格式支持**: 支持 .xlsx/.xls/.xlsm 格式

---

## 技术栈

### 核心框架
| 库 | 版本 | 用途 |
|---|---|---|
| Python | 3.10+ | 运行环境 |
| PyQt6 | 6.0.0 | 现代化跨平台 GUI 框架 |
| qt-material | 2.14 | Material Design 主题 |
| pandas | 1.5.0 | 高性能数据处理 |
| openpyxl | 3.0.0 | Excel (.xlsx) 读写及样式控制 |
| xlrd | 2.0.0 | Excel (.xls) 读取支持 |

### 可选依赖
| 库 | 用途 |
|---|---|
| pywin32 | Windows活动Excel检测 |

---

## 项目结构

```
SupplyChain-Reconciler-Plus/
 main.py                    # 应用启动入口（PyQt6）
 start.py                   # 备用启动脚本
 requirements.txt           # 依赖清单
 PROJECT_OVERVIEW.md        # 项目总文档（本文件）
 README.md                  # 快速开始指南

 config/                    # 配置模块
    __init__.py
    settings.py           # 全局常量、颜色、字段定义

 core/                      # 核心逻辑
    __init__.py
    compare_engine.py     # 数据比对引擎（主键匹配、透视处理、数据清洗）
    export_engine.py      # Excel导出引擎（颜色、格式）

 ui/                        # 界面模块（PyQt6）
    __init__.py
    qt_main_window.py     # 主窗口（三步骤流程控制）
    qt_config_panel.py    # 配置面板（主键、筛选、透视、清洗、公式）
    qt_result_preview.py  # 结果预览面板（表格 + 样例）
    qt_dialogs.py         # 对话框（加载、选择、输入、确认等）

 utils/                     # 工具模块
    __init__.py
    excel_utils.py        # Excel读写工具（支持.xls/.xlsx）
    excel_detection.py    # 活动Excel检测（Windows）
    storage.py            # 配置持久化（JSON）

 tests/                     # 测试模块
    run_tests.py          # 测试运行器
    test_core.py          # 核心功能测试
    test_asn_export.py    # ASN导出测试
    data/                 # 测试数据目录

 .github/                   # GitHub配置
     copilot-instructions.md  # AI开发约束文档
```

---

## 核心功能

### 1. 双表对账
- **手工表**: 人工录入或盘点的数据
- **系统表**: ERP/WMS/OMS等系统导出的数据
- **比对结果**: 
  -  一致（浅绿色）
  -  差异（浅黄色）
  -  缺失（浅红色）

### 2. 复合主键配置
支持多字段组合主键，例如：
- 订单编号 + 物料编码
- 客户ID + 产品SKU
- 仓库 + 批次号

### 3. 数据清洗功能
支持在对账前清洗列数据：

**清洗模式**:
- **删除匹配**: 删除匹配正则的内容
- **保留匹配**: 只保留匹配正则的内容
- **替换为**: 将匹配内容替换为指定值

**示例**: 删除到货单号末尾的序号后缀 `-\d+$`

### 4. 手工表透视聚合（出入库区分）
手工表支持按透视列区分出库和入库方向：
```
配置示例:
透视列: 业务类型
出库值: [发货, 退货]
入库值: [退仓]

计算逻辑: 手工数量 = Σ出库 - Σ入库
```

### 5. 系统表透视展开
自动处理系统表的透视数据：
```
原始数据:
订单号 | 状态   | 数量
A001  | 已完成 | 100
A001  | 处理中 | 50

透视后:
订单号 | 已完成 | 处理中 | 系统总计
A001  | 100   | 50    | 150
```

### 6. 灵活的筛选条件
支持多种筛选操作符：

| 操作符 | 说明 | 示例 |
|-------|------|------|
| 等于 | 精确匹配 | 状态 = 已完成 |
| 不等于 | 排除值 | 状态  已取消 |
| 包含 | 部分匹配（支持多值） | 备注 包含 退货,换货 |
| 不包含 | 排除部分匹配 | 备注 不包含 测试 |
| 包含于 | 值在列表中（多选） | 状态 包含于 [已完成,已发货] |
| 大于/小于 | 数值比较 | 数量 > 0 |

### 7. 自定义差值公式
使用变量名自定义公式：

**可用变量**:
- `手工数量` - 手工表聚合后的数值
- `系统总计` - 系统表聚合/透视后的总计
- `透视列名` - 系统表各透视列的值

**公式示例**:
```
手工数量 - 系统总计                    # 基本差值
手工数量 - (系统总计 - 已关闭)         # 排除某透视列
手工数量 - (已完成 + 处理中)           # 只对比指定透视列
```

### 8. 配置模板
- **保存模板**: 一键保存当前配置
- **加载模板**: 快速应用常用配置
- **覆盖模板**: 同名模板自动覆盖更新
- **删除模板**: 清理无用模板

### 9. 实时匹配预览
- **可折叠面板**: 样例显示、结果预览均可折叠
- **表格样例**: 手工表和系统表数据以表格形式显示
- **结果预览**: 显示前15行对账结果
- **状态统计**: 一致/差异/缺失数量

### 10. 彩色Excel导出
- **多Sheet**: 完整结果 + 仅差异 + 说明
- **颜色标记**: 一致(绿)/差异(黄)/缺失(红)
- **自动列宽**: 根据内容自适应

---

## 安装与运行

### 环境要求
- **操作系统**: Windows 10+ / macOS 10.14+ / Linux
- **Python**: 3.10 或更高版本
- **内存**: 建议2GB以上

### 安装步骤

```bash
# 克隆项目
git clone https://github.com/yourusername/SupplyChain-Reconciler-Plus.git
cd SupplyChain-Reconciler-Plus

# 安装依赖
pip install -r requirements.txt
```

### 运行应用

```bash
python main.py
```

---

## 使用指南

### 快速开始（3步流程）

#### 步骤1: 导入文件
1. 点击"选择手工表文件"按钮（或拖拽文件）
2. 选择Excel文件（.xlsx/.xls/.xlsm）
3. 如有多个Sheet，从下拉框选择
4. 重复操作导入系统表文件

#### 步骤2: 配置比对规则

1. **配置主键映射** - 设置手工表和系统表的对应主键列
2. **配置数值列映射** - 设置要比对的数值列
3. **配置数据清洗**（可选）- 使用正则清洗数据
4. **配置筛选条件**（可选）- 过滤不需要的数据
5. **配置透视**（可选）- 设置透视聚合规则
6. **配置差值公式** - 设置差值计算方式

#### 步骤3: 执行对账
1. 点击" 执行对账"按钮
2. 查看结果预览
3. 点击" 导出Excel"保存结果

---

## 开发说明

### 代码规范
- **风格**: 遵循PEP 8
- **命名**: 类名PascalCase，函数/变量snake_case，常量UPPER_CASE
- **注释**: 所有公共方法必须有文档字符串

### 架构设计

```
UI层 (ui/)
     调用
核心层 (core/)
     使用
工具层 (utils/)
     读取
配置层 (config/)
```

**原则**: UI不处理数据，Core不操作界面

### 核心类说明

**CompareEngine** (core/compare_engine.py)
- `clean_column()`: 数据清洗（正则处理）
- `aggregate_manual_with_pivot()`: 手工表透视聚合（出入库区分）
- `aggregate_system()`: 系统表聚合/透视
- `make_key()`: 生成复合主键
- `merge_and_compare()`: 合并比对 + 差值计算

**ExportEngine** (core/export_engine.py)
- `export_results()`: Excel导出 + 颜色标记 + 多Sheet

**QtConfigPanel** (ui/qt_config_panel.py)
- `get_config()`: 获取当前所有配置
- `set_config()`: 加载配置到UI

**QtMainWindow** (ui/qt_main_window.py)
- 三步骤流程控制
- 文件拖拽导入
- 模板管理集成

### 测试

```bash
# 运行所有测试
python -m pytest tests/

# 运行特定测试
python tests/test_core.py
python tests/test_asn_export.py
```

### 性能指标

| 数据量 | 处理时间 |
|-------|---------|
| < 1000行 | < 1秒 |
| 1000-10000行 | 1-5秒 |
| 10000-100000行 | 5-30秒 |

---

## 兼容性

- **Python**: 3.10 / 3.11 / 3.12
- **操作系统**: Windows 10/11, macOS 10.14+, Ubuntu 20.04+
- **Excel**: Microsoft Excel 2016+, WPS Office, LibreOffice Calc

---

## 文档体系

### L1 顶层文档

| 文档 | 说明 |
|------|------|
| [README.md](README.md) | 快速开始指南 |
| [CHANGELOG.md](CHANGELOG.md) | 版本历史 & 发布说明 |
| [ARCHITECTURE.md](ARCHITECTURE.md) | 系统架构设计 |
| [PROJECT_OVERVIEW.md](PROJECT_OVERVIEW.md) | 项目全局概述（本文件） |

### L2 开发约束文档

| 文档 | 说明 |
|------|------|
| [AGENT.md](AGENT.md) | AI Agent开发约束（强制） |
| [.github/copilot-instructions.md](.github/copilot-instructions.md) | 开发规范和约束 |

### L3 详细功能文档

完整的功能文档位于 `docs/` 目录（20份详细文档）：

| 入门 | 核心功能 |
|------|---------|
| [docs/01-快速开始.md](docs/01-快速开始.md) | [docs/03-数据导入.md](docs/03-数据导入.md) |
| [docs/02-安装配置.md](docs/02-安装配置.md) | [docs/04-主键配置.md](docs/04-主键配置.md) |
| | [docs/05-数据清洗.md](docs/05-数据清洗.md) |

| UI界面 | API参考 |
|-------|--------|
| [docs/10-主窗口界面.md](docs/10-主窗口界面.md) | [docs/14-核心引擎API.md](docs/14-核心引擎API.md) |
| [docs/11-配置面板.md](docs/11-配置面板.md) | [docs/15-UI组件API.md](docs/15-UI组件API.md) |
| [docs/12-结果预览.md](docs/12-结果预览.md) | [docs/16-工具函数API.md](docs/16-工具函数API.md) |
| [docs/13-对话框组件.md](docs/13-对话框组件.md) | [docs/17-配置常量.md](docs/17-配置常量.md) |

| 配置管理 | 参考资料 |
|--------|--------|
| [docs/18-模板管理.md](docs/18-模板管理.md) | [docs/19-常见问题.md](docs/19-常见问题.md) |
| [docs/20-构建与部署.md](docs/20-构建与部署.md) | [docs/README.md](docs/README.md) - 文档索引 |

### 文档特点

✅ **权威性**: docs/ 目录为所有功能文档的权威来源  
✅ **同步性**: 代码修改时自动更新相关文档  
✅ **完整性**: 覆盖用户操作、开发接口、部署步骤等全面内容  
✅ **可查阅**: 详细的API签名和代码示例

---

## 许可证

本项目采用 MIT 许可证。

---

**最后更新**: 2026年1月11日  
**文档版本**: 1.4.3
