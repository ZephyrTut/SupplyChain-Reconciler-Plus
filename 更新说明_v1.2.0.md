# 功能更新说明 v1.2.0

## 📋 本次更新内容

### 1. ✅ 优化模板功能
- **改进**：使用模板后，下拉框直接显示模板名称，无需弹窗提示
- **体验**：保存模板后自动选中新保存的模板
- **位置**：顶部模板选择器

### 2. 📊 新增数据样例预览
- **新功能**：在步骤2配置页面顶部新增手工表和系统表的数据样例预览
- **显示内容**：
  - 手工表样例（前5行）
  - 系统表样例（前5行）
  - 并排显示，最多显示10列
- **作用**：帮助用户在配置时参考原始数据结构

### 3. 🎨 优化结果预览还原导出样式
- **表头格式**：改为 `字母 (字段名)` 格式，如 `A (KEY)`、`D (手工数量)` 等
- **表头样式**：添加浅蓝色背景 (#e7f3ff)，加粗字体
- **行颜色优化**：
  - ✓一致：浅绿色背景 + 深绿色字体
  - ↕差异：浅黄色背景 + 深黄色字体
  - ✗缺失：浅红色背景 + 深红色字体
- **列宽调整**：
  - 主键列：150px
  - 比对状态：100px
  - 其他列：90px

### 4. 🔧 系统表筛选下拉框
- **改进**：系统表筛选的"值"输入框改为下拉框
- **功能**：
  - 选择列后自动加载该列的唯一值
  - 支持直接从下拉框选择，避免手动输入错误
  - 与手工表筛选保持一致的体验

### 5. 📐 差值公式快速选择
- **新增下拉框**：在"差值公式"区域添加"快速选择"下拉框
- **智能选项**：
  - 简单差值：`D - E (手工 - 系统总计)`
  - 排除透视列：`D - (E - A)` (排除特定透视列)
  - 特定透视：`D - (A + B)` (只对比指定列)
  - 透视汇总：`D - (A + B + C...)` (对比所有透视列)
- **动态更新**：选项根据实际配置的透视列自动生成
- **字母关联**：公式使用结果预览中的字母代号（A/B/C/D/E...）

### 6. 🐛 修复透视列自动变化Bug
- **问题**：之前每次配置变化都会重新计算透视值，导致透视列顺序变化
- **修复**：只在透视列字段本身变化时才重新计算透视值
- **效果**：透视列顺序保持稳定，不会因其他配置变化而改变

### 7. 📥 增强导入功能
- **拖拽支持**：已实现文件拖拽导入（可选功能，需要tkinterdnd2库）
- **格式支持**：
  - 新版Excel：.xlsx
  - 旧版Excel：.xls（需要xlrd库）
  - 带宏Excel：.xlsm
- **智能处理**：
  - 多Sheet文件自动列出所有Sheet供选择
  - 单Sheet文件自动加载
  - 拖拽失败时自动降级到文件对话框

---

## 🎯 使用建议

### 配置流程优化
1. **步骤1 - 导入文件**：
   - 可以点击按钮选择文件
   - 也可以直接拖拽文件到对应区域

2. **步骤2 - 查看样例**：
   - 导入后先查看顶部的数据样例
   - 确认手工表和系统表的字段结构

3. **步骤2 - 配置字段**：
   - 配置主键、筛选、透视等
   - 右侧实时预览会使用字母代号（A/B/C...）

4. **步骤2 - 设置公式**：
   - 查看"可用变量"了解字母对应关系
   - 使用"快速选择"下拉框选择常用公式模板
   - 或在"自定义公式"框中手动输入

5. **保存模板**：
   - 点击"💾 保存模板"
   - 输入模板名称
   - 下拉框自动选中新保存的模板

### 公式编写示例

假设结果预览显示：
- A = KEY (主键)
- B = 已完成 (透视列1)
- C = 未完成 (透视列2)
- D = 手工数量
- E = 系统总计
- F = 差值

常用公式：
```
简单差值：D - E
排除已完成：D - (E - B)
只看未完成：D - C
手工vs透视和：D - (B + C)
复杂计算：(D * 2) - (B + C * 1.5)
```

---

## 🔄 迁移指南

### 从v1.1升级到v1.2
- **向后兼容**：所有旧模板和配置文件无需修改
- **新功能自动启用**：启动应用即可使用所有新功能
- **依赖更新**：建议更新依赖
  ```bash
  pip install -r requirements.txt
  ```

### 可选依赖
- **tkinterdnd2**：用于拖拽功能（可选）
  ```bash
  pip install tkinterdnd2
  ```
- **xlrd>=2.0.0**：用于读取.xls文件（已包含在requirements.txt）

---

## 📸 界面预览

### 步骤2 - 配置页面布局
```
┌─────────────────────────────────────────────────────┐
│            📋 数据样例                               │
│  ┌──────────────────┬──────────────────┐            │
│  │ 手工表样例(前5行) │ 系统表样例(前5行) │            │
│  └──────────────────┴──────────────────┘            │
├─────────────────────────────────────────────────────┤
│  ┌───────────────┐  ┌───────────────────────────┐  │
│  │               │  │  📊 结果预览              │  │
│  │  配置面板      │  │  ┌────────────────────┐  │  │
│  │               │  │  │ A (KEY) │ D (手工量)│  │  │
│  │  - 主键配置    │  │  ├────────────────────┤  │  │
│  │  - 筛选条件    │  │  │  ...数据...        │  │  │
│  │  - 透视设置    │  │  └────────────────────┘  │  │
│  │  - 差值公式    │  │                           │  │
│  │               │  │  差值公式: D - E          │  │
│  │               │  │  列对照: D=手工, E=系统   │  │
│  └───────────────┘  └───────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

### 差值公式区域
```
┌───────────────────────────────────────┐
│ 4. 差值公式 (可选)                     │
├───────────────────────────────────────┤
│ 快速选择: [简单差值: D - E ▼]         │
│ 自定义公式: [D - E              ]     │
├───────────────────────────────────────┤
│ 可用变量（ABC代号与结果预览同步）      │
│  D  手工数量: 手工表聚合后的数值       │
│  E  系统总计: 系统表聚合/透视后的总计  │
│  透视列: B=已完成 C=未完成            │
├───────────────────────────────────────┤
│ 公式说明                              │
│  简单差值: D - E (手工数量 - 系统总计) │
│  排除某透视列: D - (E - B) (不计算已完成)│
│  只看特定列: D - (B + C) (只比对前两列)│
└───────────────────────────────────────┘
```

---

## 🙏 反馈与建议

如有问题或建议，欢迎反馈！
