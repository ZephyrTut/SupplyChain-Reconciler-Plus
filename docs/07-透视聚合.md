# 📊 透视聚合

**手工表/系统表透视处理详解**

---

## 📋 功能概述

透视聚合用于将多行数据汇总为一行，支持两种模式：

1. **手工表透视**: 区分出库/入库方向
2. **系统表透视**: 按状态列展开为多列

---

## 🔄 手工表透视（出入库区分）

### 功能说明

将手工表按透视列的值区分出库和入库，计算净数量：

```
手工数量 = Σ出库数量 - Σ入库数量
```

### 界面说明

```
┌─────────────────────────────────────────────────────────────┐
│ 📊 手工表透视（出入库）                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  透视列: ┌──────────┐                                       │
│          │ 业务类型 ▼│                                       │
│          └──────────┘                                       │
│                                                             │
│  出库值: ┌──────────────────────────────────────┐           │
│          │ ☑ 发货  ☑ 退货  ☐ 退仓  ☐ 入库     │           │
│          └──────────────────────────────────────┘           │
│                                                             │
│  入库值: ┌──────────────────────────────────────┐           │
│          │ ☐ 发货  ☐ 退货  ☑ 退仓  ☑ 入库     │           │
│          └──────────────────────────────────────┘           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 配置步骤

1. **选择透视列**: 选择区分出入库方向的列
2. **勾选出库值**: 勾选表示出库的值
3. **勾选入库值**: 勾选表示入库的值

### 计算示例

**原始数据**:
| 订单号 | 业务类型 | 数量 |
|--------|---------|------|
| A001 | 发货 | 100 |
| A001 | 退货 | 20 |
| A001 | 退仓 | 10 |

**配置**:
- 透视列: 业务类型
- 出库值: [发货, 退货]
- 入库值: [退仓]

**计算过程**:
```
出库合计 = 100(发货) + 20(退货) = 120
入库合计 = 10(退仓) = 10
手工数量 = 120 - 10 = 110
```

**结果**:
| __KEY__ | 发货 | 退货 | 退仓 | 手工数量 |
|---------|------|------|------|---------|
| A001 | 100 | 20 | 10 | 110 |

---

## 📈 系统表透视

### 功能说明

将系统表按透视列的值展开为多列，并计算总计：

```
系统总计 = Σ所有透视列
```

### 界面说明

```
┌─────────────────────────────────────────────────────────────┐
│ 📊 系统表透视                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  透视列: ┌──────────┐                                       │
│          │ 订单状态 ▼│                                       │
│          └──────────┘                                       │
│                                                             │
│  透视值: ┌──────────────────────────────────────┐           │
│          │ 已完成, 处理中, 待审核               │           │
│          └──────────────────────────────────────┘           │
│          (自动加载该列的唯一值)                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 配置步骤

1. **选择透视列**: 选择要展开的状态列
2. **查看透视值**: 系统自动加载该列的所有唯一值

### 计算示例

**原始数据**:
| 订单号 | 订单状态 | 数量 |
|--------|---------|------|
| A001 | 已完成 | 80 |
| A001 | 处理中 | 15 |
| A001 | 待审核 | 5 |
| A002 | 已完成 | 200 |

**配置**:
- 透视列: 订单状态

**结果**:
| __KEY__ | 已完成 | 处理中 | 待审核 | 系统总计 |
|---------|--------|--------|--------|---------|
| A001 | 80 | 15 | 5 | 100 |
| A002 | 200 | 0 | 0 | 200 |

---

## 📊 透视与非透视对比

### 不使用透视

直接按主键聚合求和：

```
原始:
A001, 已完成, 80
A001, 处理中, 15

结果:
A001, 系统总计=95
```

### 使用透视

按主键和透视列展开：

```
原始:
A001, 已完成, 80
A001, 处理中, 15

结果:
A001, 已完成=80, 处理中=15, 系统总计=95
```

**优势**: 可在公式中排除特定状态

---

## 🧮 透视与公式配合

### 排除特定透视列

```
场景: 不对账"已关闭"的数量

透视结果:
| KEY | 已完成 | 已关闭 | 系统总计 |
| A001 | 80 | 20 | 100 |

公式: 手工数量 - (系统总计 - 已关闭)
计算: 手工数量 - (100 - 20) = 手工数量 - 80
```

### 只对账特定透视列

```
场景: 只对账"已完成+处理中"

公式: 手工数量 - (已完成 + 处理中)
```

---

## 📝 配置示例

### 示例1: ASN送货单对账

**手工表**: 到货记录（有出入库区分）
```
透视列: 业务类型
出库值: [正常到货, 补货]
入库值: [退货]
```

**系统表**: 执行报表（有状态区分）
```
透视列: 执行状态
透视值: [已完成, 部分完成, 未开始]
```

### 示例2: 库存盘点对账

**手工表**: 盘点记录
```
透视列: 盘点类型
出库值: [盘盈]
入库值: [盘亏]
```

**系统表**: ERP库存
```
不使用透视（直接取库存数量）
```

### 示例3: 订单执行对账

**手工表**: 发货记录
```
不使用透视（直接取发货数量）
```

**系统表**: 订单明细
```
透视列: 订单状态
透视值: [待发货, 已发货, 已签收, 已取消]
```

---

## ⚠️ 注意事项

### 1. 透视列值必须存在

选择的出库值/入库值必须是该列实际存在的值。

### 2. 出入库值不能重复

同一个值不能同时是出库和入库。

### 3. 未勾选的值会被忽略

手工表透视时，未勾选的业务类型行不参与计算。

### 4. 透视会改变数据结构

透视后每个主键只有一行，多行数据被汇总。

---

## 💻 技术实现

### 手工表透视配置格式

```python
manual_pivot_config = {
    "pivot_column": "业务类型",
    "out_values": ["发货", "退货"],
    "in_values": ["退仓"]
}
```

### 系统表透视配置格式

```python
system_pivot_config = {
    "pivot_column": "订单状态",
    "pivot_values": ["已完成", "处理中", "待审核"]
}
```

### 核心函数

```python
# 手工表透视聚合
df, out_cols, in_cols = CompareEngine.aggregate_manual_with_pivot(
    df=manual_df,
    key_col="__KEY__",
    value_col="数量",
    pivot_config=manual_pivot_config,
    filters=[]
)
# 结果: 手工数量 = Σout_cols - Σin_cols

# 系统表透视聚合
df, pivot_values = CompareEngine.aggregate_system(
    df=system_df,
    key_col="__KEY__",
    value_cols=["数量"],
    pivot_column="订单状态",
    filters=[]
)
# 结果: 展开为多列 + 系统总计
```

### 透视实现

```python
# pandas pivot_table
pivot_df = df.pivot_table(
    index=key_col,
    columns=pivot_column,
    values=value_col,
    aggfunc='sum',
    fill_value=0
).reset_index()

# 计算总计
pivot_df["系统总计"] = pivot_df[pivot_values].sum(axis=1)
```

---

## ▶️ 下一步

透视配置完成后，继续配置 [差值公式](./08-差值公式.md)。
