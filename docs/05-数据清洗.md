# 🧹 数据清洗

**正则表达式批量清洗列数据**

---

## 📋 功能概述

数据清洗用于在对账前预处理数据，解决两表数据格式不一致的问题。

### 常见清洗场景

| 场景 | 原始值 | 清洗后 | 正则表达式 |
|------|--------|--------|-----------|
| 去除末尾序号 | `ASN001-1` | `ASN001` | `-\d+$` |
| 只保留数字 | `ABC123XYZ` | `123` | `[^\d]+` |
| 去除中文 | `订单A001` | `A001` | `[\u4e00-\u9fa5]+` |
| 去除空格 | ` A001 ` | `A001` | `^\s+\|\s+$` |

---

## 🎨 界面说明

### 数据清洗区域

```
┌─────────────────────────────────────────────────────────────┐
│ 🧹 数据清洗                                      [➕ 添加]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌────────┐  ┌────────┐  ┌──────────────────────┐          │
│  │到货单号▼│  │删除匹配▼│  │ -\d+$               │   [✕]   │
│  └────────┘  └────────┘  └──────────────────────┘          │
│      列         模式            正则表达式                   │
│                                                             │
│  预设: [去中文] [去末尾英文] [只留数字] [去特殊符号]         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 界面元素

| 元素 | 说明 |
|------|------|
| 列下拉框 | 选择要清洗的列 |
| 模式下拉框 | 选择清洗模式 |
| 正则输入框 | 输入正则表达式 |
| 预设按钮 | 快速填入常用正则 |
| ✕ 按钮 | 删除该清洗规则 |
| ➕ 添加 | 添加新的清洗规则 |

---

## 🔄 清洗模式

### 模式1: 删除匹配

**功能**: 删除匹配正则的内容，保留其他内容

**示例**:
```
原始值: ASN001-1-2
正则: -\d+$
结果: ASN001-1     (删除了末尾的 -2)

再次应用:
结果: ASN001       (删除了末尾的 -1)
```

### 模式2: 保留匹配

**功能**: 只保留匹配正则的内容，删除其他

**示例**:
```
原始值: 订单ABC123号
正则: \d+
结果: 123          (只保留数字)
```

### 模式3: 替换为

**功能**: 将匹配的内容替换为指定值

**示例**:
```
原始值: 2026-01-11
正则: -
替换为: /
结果: 2026/01/11   (横杠替换为斜杠)
```

---

## 📝 预设清洗规则

系统内置常用清洗规则，点击即可应用：

| 预设 | 正则表达式 | 说明 | 示例 |
|------|-----------|------|------|
| 去中文 | `[\u4e00-\u9fa5]+` | 删除所有中文字符 | `订单A001` → `A001` |
| 去末尾英文 | `[a-zA-Z]+$` | 删除末尾英文 | `A001abc` → `A001` |
| 去开头英文 | `^[a-zA-Z]+` | 删除开头英文 | `ABCa001` → `a001` |
| 只留数字 | `[^\d]+` | 删除所有非数字 | `A-001-B` → `001` |
| 去特殊符号 | `[^\w\s\u4e00-\u9fa5]+` | 删除特殊符号 | `A@#001` → `A001` |
| 去空格 | `^\s+\|\s+$` | 去除首尾空格 | ` A001 ` → `A001` |

---

## 📊 正则表达式速查

### 常用元字符

| 符号 | 含义 | 示例 |
|------|------|------|
| `.` | 匹配任意字符 | `a.c` → abc, aXc |
| `*` | 匹配0次或多次 | `ab*` → a, ab, abb |
| `+` | 匹配1次或多次 | `ab+` → ab, abb |
| `?` | 匹配0次或1次 | `ab?` → a, ab |
| `^` | 匹配开头 | `^A` → A开头的 |
| `$` | 匹配结尾 | `A$` → A结尾的 |
| `\d` | 匹配数字 | `\d+` → 123 |
| `\w` | 匹配字母数字下划线 | `\w+` → abc_123 |
| `\s` | 匹配空白字符 | `\s+` → 空格、制表符 |
| `[]` | 字符集 | `[abc]` → a或b或c |
| `[^]` | 非字符集 | `[^abc]` → 非a非b非c |

### 常用正则模式

| 用途 | 正则表达式 |
|------|-----------|
| 匹配数字 | `\d+` |
| 匹配非数字 | `[^\d]+` |
| 匹配末尾数字 | `\d+$` |
| 匹配开头数字 | `^\d+` |
| 匹配中文 | `[\u4e00-\u9fa5]+` |
| 匹配日期 | `\d{4}-\d{2}-\d{2}` |
| 匹配括号内容 | `\([^)]*\)` |

---

## 📝 配置示例

### 示例1: ASN单号去后缀

**场景**: 到货单号有分批后缀，需要去除

```
原始: ASN20260111001-1, ASN20260111001-2
目标: ASN20260111001

配置:
列: 到货单号
模式: 删除匹配
正则: -\d+$
```

### 示例2: 只提取数字

**场景**: 物料编码混有字母，只需数字部分

```
原始: MAT-001-A, MAT-002-B
目标: 001, 002

配置:
列: 物料编码
模式: 保留匹配
正则: \d+
```

### 示例3: 统一日期格式

**场景**: 日期格式不一致

```
原始: 2026-01-11
目标: 2026/01/11

配置:
列: 日期
模式: 替换为
正则: -
替换值: /
```

### 示例4: 去除括号备注

**场景**: 产品名称有括号备注

```
原始: 螺丝(M3x10), 螺母(M3)
目标: 螺丝, 螺母

配置:
列: 产品名称
模式: 删除匹配
正则: \([^)]*\)
```

---

## 🔗 多规则链式清洗

可以添加多条清洗规则，按顺序执行：

```
规则1: 去除末尾序号 (-\d+$)
规则2: 去除首尾空格 (^\s+|\s+$)
规则3: 转换分隔符 (- → /)
```

**执行顺序**: 规则1 → 规则2 → 规则3

---

## ⚠️ 注意事项

### 1. 清洗会修改数据

清洗是**不可逆**操作，原始数据会被修改（仅在内存中）。

💡 可使用「导出预处理预览」查看清洗效果。

### 2. 正则表达式测试

建议先用少量数据测试正则是否正确：

1. 配置清洗规则
2. 点击「导出预处理预览」
3. 检查清洗结果是否符合预期

### 3. 特殊字符转义

如需匹配特殊字符本身，需要转义：

| 字符 | 转义写法 |
|------|---------|
| `.` | `\.` |
| `*` | `\*` |
| `+` | `\+` |
| `?` | `\?` |
| `(` | `\(` |
| `)` | `\)` |
| `[` | `\[` |
| `]` | `\]` |

---

## 💻 技术实现

### 配置数据格式

```python
clean_rules = [
    {
        "column": "到货单号",
        "mode": "删除匹配",
        "regexes": ["-\\d+$"],
        "replace": ""
    }
]
```

### 核心函数

```python
from core.compare_engine import CompareEngine

# 清洗列数据
df = CompareEngine.clean_column(df, clean_rules)
```

### 实现逻辑

```python
if mode == "删除匹配":
    df[column] = df[column].str.replace(regex, "", regex=True)
elif mode == "保留匹配":
    df[column] = df[column].str.extract(f"({regex})", expand=False)
elif mode == "替换为":
    df[column] = df[column].str.replace(regex, replace_val, regex=True)
```

---

## ▶️ 下一步

数据清洗配置完成后，继续配置 [筛选条件](./06-筛选条件.md)。
