name: Build and Release (Windows)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: v1.4.4)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set tag variable
        id: set_tag
        run: |
          # å®‰å…¨åœ°è®¾ç½®æ ‡ç­¾å˜é‡
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.version_tag }}"
          else
            TAG="v1.0.0"
          fi
          # æ¸…é™¤æ¢è¡Œç¬¦å’Œç‰¹æ®Šå­—ç¬¦
          CLEAN_TAG=$(echo "$TAG" | tr -d '\n\r' | sed 's/[^a-zA-Z0-9._-]/-/g')
          echo "TAG=$CLEAN_TAG" >> $GITHUB_ENV
          echo "tag=$CLEAN_TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $CLEAN_TAG"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --windowed --name SupplyChain-Reconciler-Plus main.py

      - name: Zip artifact
        shell: powershell
        run: |
          $tag = "${{ env.TAG }}"
          Write-Host "Creating package for tag: $tag"
          
          $exe = Join-Path $PWD 'dist\SupplyChain-Reconciler-Plus.exe'
          $zip = Join-Path $PWD "dist\reconciler-$tag-windows.zip"
          
          if (Test-Path $exe) { 
              Compress-Archive -Path $exe -DestinationPath $zip -Force 
              Write-Host "âœ“ Created zip: $zip"
          }
          else { 
              Write-Error "Executable not found: $exe"
              exit 1 
          }

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: Release ${{ env.TAG }}
          draft: false
          prerelease: false
          files: |
            dist/reconciler-${{ env.TAG }}-windows.zip
            dist/SupplyChain-Reconciler-Plus.exe
          body: |
            # Supply Chain Reconciler Plus ${{ env.TAG }}
            
            ## ğŸ“¦ ä¸‹è½½
            - **reconciler-${{ env.TAG }}-windows.zip**: åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶çš„å‹ç¼©åŒ…
            - **SupplyChain-Reconciler-Plus.exe**: å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
            
            ## ğŸš€ ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½å¹¶è§£å‹
            2. åŒå‡»è¿è¡Œ `SupplyChain-Reconciler-Plus.exe`
            
            ## âš ï¸ æ³¨æ„äº‹é¡¹
            - ä»…æ”¯æŒ Windows ç³»ç»Ÿ
            - é¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}