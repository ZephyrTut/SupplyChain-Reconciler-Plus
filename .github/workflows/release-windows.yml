name: Build and Release (Windows)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version_tag:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: v1.4.4)'
        required: true
        default: 'v1.0.0'

# å…è®¸åœ¨ workflow ä¸­ä½¿ç”¨ GITHUB_TOKEN åˆ›å»º release / ä¸Šä¼ èµ„æº
permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version tag
        id: get_tag
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            # æ ‡ç­¾æ¨é€ï¼šä»refä¸­æå–æ ‡ç­¾å
            TAG="${GITHUB_REF#refs/tags/}"
            echo "Using push tag: $TAG"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨è¾“å…¥å‚æ•°
            TAG="${{ github.event.inputs.version_tag }}"
            echo "Using manual tag: $TAG"
          else
            # å…¶ä»–æƒ…å†µï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰
            TAG="v1.0.0"
            echo "Using default tag: $TAG"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --windowed --name SupplyChain-Reconciler-Plus main.py

      - name: Zip artifact
        shell: powershell
        run: |
          # ä½¿ç”¨æ­¥éª¤è¾“å‡ºçš„æ ‡ç­¾
          $tag = '${{ steps.get_tag.outputs.tag }}'
          Write-Host "Creating package for tag: $tag"
          
          $exe = Join-Path $PWD 'dist\SupplyChain-Reconciler-Plus.exe'
          $zip = Join-Path $PWD "dist\reconciler-$tag-windows.zip"
          
          if (Test-Path $exe) { 
            Compress-Archive -Path $exe -DestinationPath $zip -Force 
            Write-Host "âœ“ Created zip: $zip"
          }
          else { 
            Write-Error "Executable not found: $exe"
            exit 1 
          }

      - name: Check executable
        shell: powershell
        run: |
          $exe = Join-Path $PWD 'dist\SupplyChain-Reconciler-Plus.exe'
          $zip = Join-Path $PWD "dist\reconciler-${{ steps.get_tag.outputs.tag }}-windows.zip"
          
          Write-Host "Verifying build artifacts..."
          if (Test-Path $exe) {
            $exeInfo = Get-Item $exe
            Write-Host "âœ… Executable: $($exeInfo.Name)"
            Write-Host "   Size: $([math]::Round($exeInfo.Length/1MB, 2)) MB"
          } else {
            Write-Error "âŒ Executable not found: $exe"
            exit 1
          }
          
          if (Test-Path $zip) {
            $zipInfo = Get-Item $zip
            Write-Host "âœ… Zip package: $($zipInfo.Name)"
            Write-Host "   Size: $([math]::Round($zipInfo.Length/1MB, 2)) MB"
          } else {
            Write-Error "âŒ Zip package not found: $zip"
            exit 1
          }

      - name: Create Release (only for tag pushes)
        id: create_release
        # åªåœ¨æ ‡ç­¾æ¨é€æ—¶åˆ›å»ºReleaseï¼Œæ‰‹åŠ¨è§¦å‘æ—¶è·³è¿‡
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: Release ${{ steps.get_tag.outputs.tag }}
          draft: false
          prerelease: false
          files: |
            dist/reconciler-${{ steps.get_tag.outputs.tag }}-windows.zip
            dist/SupplyChain-Reconciler-Plus.exe
          body: |
            # Supply Chain Reconciler Plus ${{ steps.get_tag.outputs.tag }}
            
            ## ğŸ“¦ ä¸‹è½½
            - **reconciler-${{ steps.get_tag.outputs.tag }}-windows.zip**: åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶çš„å‹ç¼©åŒ…
            - **SupplyChain-Reconciler-Plus.exe**: å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¯ä»zipä¸­æå–ï¼‰
            
            ## ğŸš€ ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½å¹¶è§£å‹
            2. åŒå‡»è¿è¡Œ `SupplyChain-Reconciler-Plus.exe`
            
            ## âš ï¸ æ³¨æ„äº‹é¡¹
            - ä»…æ”¯æŒ Windows ç³»ç»Ÿ
            - é¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
            
            ## ğŸ”§ æ„å»ºä¿¡æ¯
            - æ„å»ºæ—¶é—´: ${{ steps.get_tag.outputs.tag }}
            - Python ç‰ˆæœ¬: 3.11
            - æ„å»ºå·¥å…·: PyInstaller
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (for manual runs)
        # æ‰‹åŠ¨è§¦å‘æ—¶ä¸Šä¼ åˆ°Artifactsï¼Œä¾¿äºä¸‹è½½æµ‹è¯•
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v3
        with:
          name: SupplyChain-Reconciler-Plus-${{ steps.get_tag.outputs.tag }}
          path: |
            dist/SupplyChain-Reconciler-Plus.exe
            dist/reconciler-${{ steps.get_tag.outputs.tag }}-windows.zip
          retention-days: 7