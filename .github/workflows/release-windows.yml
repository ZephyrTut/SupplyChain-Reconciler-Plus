name: Build and Release (Windows)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # æ·»åŠ è¿™è¡Œï¼Œå…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version_tag:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: v1.4.4)'
        required: true
        default: 'v1.0.0'
      skip_release:
        description: 'è·³è¿‡åˆ›å»º GitHub Release'
        required: false
        default: false

# å…è®¸åœ¨ workflow ä¸­ä½¿ç”¨ GITHUB_TOKEN åˆ›å»º release / ä¸Šä¼ èµ„æº
permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        run: |
          pyinstaller --noconfirm --onefile --windowed --name SupplyChain-Reconciler-Plus main.py

      - name: Zip artifact
        shell: powershell
        run: |
          $tag = '${{ github.ref_name }}'
          $exe = Join-Path $PWD 'dist\SupplyChain-Reconciler-Plus.exe'
          $zip = Join-Path $PWD "dist\reconciler-$tag-windows.zip"
          if (Test-Path $exe) { 
            Compress-Archive -Path $exe -DestinationPath $zip -Force 
            Write-Host "âœ“ Created zip: $zip"
          }
          else { 
            Write-Error "Executable not found: $exe"
            exit 1 
          }

      # æ–¹æ¡ˆ1ï¼šç®€åŒ–çš„åˆ›å»ºå‘å¸ƒæ–¹æ³•ï¼ˆæ¨èï¼‰
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            dist/reconciler-${{ github.ref_name }}-windows.zip
            dist/SupplyChain-Reconciler-Plus.exe
          body: |
            # Supply Chain Reconciler Plus ${{ github.ref_name }}
            
            ## ğŸ“¦ ä¸‹è½½
            - **reconciler-${{ github.ref_name }}-windows.zip**: åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶çš„å‹ç¼©åŒ…
            - **SupplyChain-Reconciler-Plus.exe**: å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
            
            ## ğŸš€ ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½å¹¶è§£å‹
            2. åŒå‡»è¿è¡Œ `SupplyChain-Reconciler-Plus.exe`
            
            ## âš ï¸ æ³¨æ„äº‹é¡¹
            - ä»…æ”¯æŒ Windows ç³»ç»Ÿ
            - é¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ–¹æ¡ˆ2ï¼šå¦‚æœæ‚¨æƒ³ä¿ç•™åŸæœ‰é€»è¾‘ï¼Œä¿®å¤ç‰ˆæœ¬
      # - name: Get Release Upload URL
      #   id: get_upload_url
      #   uses: actions/github-script@v6
      #   with:
      #     script: |
      #       const { owner, repo } = context.repo;
      #       const tag = context.ref.replace('refs/tags/', '');
      #       
      #       try {
      #         // å°è¯•è·å–å·²å­˜åœ¨çš„å‘å¸ƒ
      #         const release = await github.rest.repos.getReleaseByTag({
      #           owner,
      #           repo,
      #           tag
      #         });
      #         core.setOutput('upload_url', release.data.upload_url);
      #         console.log(`Release already exists for tag ${tag}`);
      #       } catch (error) {
      #         if (error.status === 404) {
      #           // åˆ›å»ºæ–°å‘å¸ƒ
      #           const newRelease = await github.rest.repos.createRelease({
      #             owner,
      #             repo,
      #             tag_name: tag,
      #             name: `Release ${tag}`,
      #             draft: false,
      #             prerelease: false
      #           });
      #           core.setOutput('upload_url', newRelease.data.upload_url);
      #           console.log(`Created new release for tag ${tag}`);
      #         } else {
      #           throw error;
      #         }
      #       }
      # 
      # - name: Upload Release Asset
      #   uses: actions/upload-release-asset@v1
      #   with:
      #     upload_url: ${{ steps.get_upload_url.outputs.upload_url }}
      #     asset_path: dist/reconciler-${{ github.ref_name }}-windows.zip
      #     asset_name: reconciler-${{ github.ref_name }}-windows.zip
      #     asset_content_type: application/zip
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}